<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Assistant • Earth Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%2300a2ff"/></svg>'>
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); }
    .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(148, 163, 184, 0.1); }
    .chip { background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(148, 163, 184, 0.2); transition: all 0.2s; cursor: pointer; }
    .chip:hover { background: rgba(71, 85, 105, 0.5); transform: translateY(-1px); }
    .chip.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-color: rgba(139, 92, 246, 0.5); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
    .msg-slide { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .typing span { width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; animation: typing 1.4s infinite; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-8px); } }
    
    /* Scrollbar Hiding */
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    /* Custom Scrollbar for Messages */
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 3px; }
    #messages::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.5); }
    
    /* Textarea Auto-resize */
    #input { 
      field-sizing: content;
      line-height: 1.5;
      scrollbar-width: none;
    }
    #input::-webkit-scrollbar { display: none; }
    
    /* Keyboard shortcuts */
    kbd { font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace; }
    
    @media (max-width: 768px) { 
      .sidebar-hide { transform: translateX(-100%); }
      #prompts { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
    }
  </style>
</head>
<body class="text-white h-screen overflow-hidden">
  <!-- Mobile Header -->
  <header class="md:hidden glass border-b border-slate-700/50 px-4 py-3 flex items-center justify-between">
    <button id="menuBtn" class="p-2 hover:bg-white/10 rounded-lg">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>
    <div class="flex items-center gap-2">
      <div class="w-2 h-2 rounded-full bg-violet-400 animate-pulse"></div>
      <h1 class="text-lg font-semibold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">AI Assistant</h1>
    </div>
    <a href="/public/EARTH.html" class="p-2 hover:bg-white/10 rounded-lg">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    </a>
  </header>

  <div class="flex h-[calc(100vh-60px)] md:h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-hide fixed md:relative z-40 w-80 h-full glass border-r border-slate-700/50 overflow-y-auto transition-transform duration-300 md:translate-x-0">
      <div class="hidden md:block glass border-b border-slate-700/50 p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-violet-400 animate-pulse"></div>
            <h1 class="text-lg font-semibold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">AI Assistant</h1>
          </div>
          <a href="/public/EARTH.html" class="p-2 hover:bg-white/10 rounded-lg">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/></svg>
          </a>
        </div>
        <p class="text-xs text-slate-400">Context-aware Earth analysis</p>
      </div>

      <div class="p-4 space-y-6">
        <section>
          <div class="flex items-center gap-2 mb-3">
            <svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            <h2 class="text-sm font-semibold">Anomaly Types</h2>
          </div>
          <div id="anomalyChips" class="flex flex-wrap gap-2">
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full active" data-value="All">All</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="Wildfires">Wildfires</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="Floods">Floods</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="Storms">Storms</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="Dust">Dust</button>
        </div>
      </section>

      <section>
          <div class="flex items-center gap-2 mb-3">
            <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M3 7l9-4 9 4-9 4-9-4zm0 5l9 4 9-4v6l-9 4-9-4v-6z"/></svg>
            <h2 class="text-sm font-semibold">NASA Layers</h2>
          </div>
          <div id="layerChips" class="flex flex-wrap gap-2">
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="BlueMarble">BlueMarble</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="IMERG">IMERG</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="SST">SST</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="MODIS">MODIS</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="VIIRS">VIIRS</button>
            <button class="chip px-3 py-1.5 text-xs font-medium rounded-full" data-value="NDVI">NDVI</button>
        </div>
      </section>

        <section>
          <div class="flex items-center gap-2 mb-3">
            <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
            <h2 class="text-sm font-semibold">Date Range</h2>
          </div>
          <div class="space-y-3">
          <div>
              <label class="block text-xs text-slate-400 mb-1.5">From</label>
              <input id="dateFrom" type="date" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-violet-400/50">
          </div>
          <div>
              <label class="block text-xs text-slate-400 mb-1.5">To</label>
              <input id="dateTo" type="date" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-violet-400/50">
          </div>
        </div>
      </section>
      </div>
    </aside>

    <div id="backdrop" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-30 md:hidden"></div>

    <!-- Main Chat -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <header class="hidden md:block glass border-b border-slate-700/50 px-6 py-4">
        <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-semibold mb-1">Earth Analysis AI</h2>
            <p class="text-sm text-slate-400">Powered by Gemini • Real-time NASA data</p>
          </div>
          <div class="px-3 py-1.5 bg-violet-500/10 border border-violet-500/30 rounded-full">
            <span class="text-xs font-medium text-violet-300">AI Active</span>
          </div>
        </div>
      </header>

      <div id="messages" class="flex-1 overflow-y-auto px-4 py-6 md:px-6 space-y-4">
        <div class="flex gap-3 msg-slide">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
          </div>
          <div class="flex-1 max-w-3xl">
            <div class="glass rounded-2xl rounded-tl-none px-4 py-3">
              <p class="text-sm leading-relaxed text-slate-200 font-medium mb-2">Welcome to Earth Analysis AI Assistant</p>
              <p class="text-sm text-slate-300 mb-3">I specialize in analyzing climate data and environmental patterns. I can help you understand:</p>
              <ul class="mt-2 space-y-1.5 text-sm text-slate-300">
                <li class="flex items-start gap-2"><span class="text-violet-400">•</span><span>Real-time NASA EONET anomaly data (storms, wildfires, floods)</span></li>
                <li class="flex items-start gap-2"><span class="text-violet-400">•</span><span>Climate anomalies and environmental changes</span></li>
                <li class="flex items-start gap-2"><span class="text-violet-400">•</span><span>NASA satellite data and observations</span></li>
                <li class="flex items-start gap-2"><span class="text-violet-400">•</span><span>Weather patterns and predictions</span></li>
                <li class="flex items-start gap-2"><span class="text-violet-400">•</span><span>Environmental impact assessments</span></li>
              </ul>
              <p class="mt-3 text-xs text-slate-400 border-t border-slate-700/50 pt-2">Tip: I have access to real-time NASA EONET data. Ask about recent storms, wildfires, or other anomalies with specific locations and details.</p>
            </div>
            <div class="mt-2 text-xs text-slate-500">Just now</div>
          </div>
          </div>
        </div>

      <footer class="glass border-t border-slate-700/50 p-3 md:p-4">
        <div class="max-w-5xl mx-auto">
          <!-- Suggested Prompts -->
          <div id="prompts" class="mb-3 overflow-x-auto pb-2 scrollbar-hide">
            <div class="flex gap-2 min-w-max">
              <button class="px-4 py-2 text-xs font-medium bg-gradient-to-br from-slate-800/80 to-slate-700/60 hover:from-violet-600/20 hover:to-fuchsia-600/20 border border-slate-600/40 hover:border-violet-500/50 rounded-xl text-slate-300 hover:text-white transition-all duration-200 shadow-lg hover:shadow-violet-500/20 whitespace-nowrap" data-prompt="What are the current global temperature anomalies?">
                <svg class="w-3 h-3 inline mr-1.5" fill="currentColor" viewBox="0 0 24 24"><path d="M15 13h1.5v2.82l2.44 1.41-.75 1.3L15 16.69V13zm4-5H5v11h4.67c-.43-.91-.67-1.93-.67-3 0-3.87 3.13-7 7-7 1.07 0 2.09.24 3 .67V8zM5 21c-1.11 0-2-.89-2-2V5c0-1.11.89-2 2-2h1V1h2v2h8V1h2v2h1c1.11 0 2 .89 2 2v4.81c.88.69 1.59 1.58 2.08 2.6L22 9V5c0-1.66-1.34-3-3-3h-1V0h-2v2H8V0H6v2H5C3.34 2 2 3.34 2 5v14c0 1.66 1.34 3 3 3h5.09c-.05-.33-.09-.66-.09-1H5z"/><path d="M16 18c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                Temperature Trends
              </button>
              <button class="px-4 py-2 text-xs font-medium bg-gradient-to-br from-slate-800/80 to-slate-700/60 hover:from-violet-600/20 hover:to-fuchsia-600/20 border border-slate-600/40 hover:border-violet-500/50 rounded-xl text-slate-300 hover:text-white transition-all duration-200 shadow-lg hover:shadow-violet-500/20 whitespace-nowrap" data-prompt="Show me recent wildfire activity">
                <svg class="w-3 h-3 inline mr-1.5" fill="currentColor" viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>
                Wildfire Activity
              </button>
              <button class="px-4 py-2 text-xs font-medium bg-gradient-to-br from-slate-800/80 to-slate-700/60 hover:from-violet-600/20 hover:to-fuchsia-600/20 border border-slate-600/40 hover:border-violet-500/50 rounded-xl text-slate-300 hover:text-white transition-all duration-200 shadow-lg hover:shadow-violet-500/20 whitespace-nowrap" data-prompt="Tell me about recent storms detected by NASA">
                <svg class="w-3 h-3 inline mr-1.5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                Recent Storms
              </button>
              <button class="px-4 py-2 text-xs font-medium bg-gradient-to-br from-slate-800/80 to-slate-700/60 hover:from-violet-600/20 hover:to-fuchsia-600/20 border border-slate-600/40 hover:border-violet-500/50 rounded-xl text-slate-300 hover:text-white transition-all duration-200 shadow-lg hover:shadow-violet-500/20 whitespace-nowrap" data-prompt="Explain the NDVI data layer">
                <svg class="w-3 h-3 inline mr-1.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                NDVI Layer Info
              </button>
        </div>
      </div>

          <!-- Input Area -->
          <div class="relative">
            <div class="flex items-end gap-2 bg-gradient-to-br from-slate-800/60 to-slate-900/60 backdrop-blur-xl border border-slate-600/40 rounded-3xl p-2 shadow-2xl hover:border-violet-500/30 transition-all duration-300">
              <div class="flex-1 relative flex items-center">
                <textarea id="input" rows="1" placeholder="Ask about climate data, anomalies, or Earth observations..." class="w-full px-4 py-3 bg-transparent text-sm text-white placeholder-slate-400 focus:outline-none resize-none overflow-hidden" style="max-height:100px; min-height:44px"></textarea>
                <div class="flex items-center gap-1 pr-2">
                  <button id="voiceBtn" class="p-2 hover:bg-violet-500/20 rounded-xl transition-all duration-200 group" title="Voice input">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-violet-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
          </button>
                  <div class="h-6 w-px bg-slate-600/50"></div>
                  <span id="count" class="text-xs text-slate-500 font-medium px-2 whitespace-nowrap">0/2000</span>
                </div>
              </div>
              <button id="sendBtn" class="flex-shrink-0 p-3 bg-gradient-to-br from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 rounded-2xl font-medium text-sm transition-all duration-200 shadow-lg shadow-violet-500/30 hover:shadow-violet-500/50 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100" title="Send message">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
            </div>
            <div class="mt-2 px-2 flex items-center justify-between text-xs text-slate-500">
              <span class="flex items-center gap-1">
                <kbd class="px-1.5 py-0.5 bg-slate-800/50 border border-slate-700 rounded text-[10px]">Enter</kbd>
                <span>to send</span>
                <span class="mx-1">•</span>
                <kbd class="px-1.5 py-0.5 bg-slate-800/50 border border-slate-700 rounded text-[10px]">Shift+Enter</kbd>
                <span>for new line</span>
              </span>
            </div>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <script type="module">
    import { GoogleGenerativeAI } from 'https://esm.run/@google/generative-ai';
    
    // Gemini API Configuration - Using Gemini 2.0 Flash (stable version)
    const API_KEY = 'AIzaSyCGYNwiZz-LZSURDdQZhmLVFTRI6cjtqm8';
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });
    
    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    const menuBtn = document.getElementById('menuBtn');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const count = document.getElementById('count');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    const voiceBtn = document.getElementById('voiceBtn');
    
    // State Management
    let anomalies = ['All'];
    let layers = [];
    let isProcessing = false;
    let retryCount = 0;
    const MAX_RETRIES = 3;
    let eonetData = [];
    
    // Initialize dates
    const today = new Date();
    const ago30 = new Date(today.getTime() - 30 * 864e5);
    dateTo.value = today.toISOString().split('T')[0];
    dateFrom.value = ago30.toISOString().split('T')[0];
    
    // Load EONET data on initialization
    loadEONETData();
    
    // Event Listeners
    menuBtn?.addEventListener('click', () => {
      sidebar.classList.toggle('sidebar-hide');
      backdrop.classList.toggle('hidden');
    });
    
    backdrop.addEventListener('click', () => {
      sidebar.classList.add('sidebar-hide');
      backdrop.classList.add('hidden');
    });
    
    // Anomaly chips
    document.querySelectorAll('#anomalyChips .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const value = chip.dataset.value;
        if (value === 'All') {
          document.querySelectorAll('#anomalyChips .chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          anomalies = ['All'];
        } else {
          document.querySelector('#anomalyChips .chip[data-value="All"]').classList.remove('active');
          chip.classList.toggle('active');
          anomalies = Array.from(document.querySelectorAll('#anomalyChips .chip.active')).map(c => c.dataset.value);
          if (anomalies.length === 0) {
            document.querySelector('#anomalyChips .chip[data-value="All"]').classList.add('active');
            anomalies = ['All'];
          }
        }
      });
    });
    
    // Layer chips
    document.querySelectorAll('#layerChips .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        chip.classList.toggle('active');
        layers = Array.from(document.querySelectorAll('#layerChips .chip.active')).map(c => c.dataset.value);
      });
    });
    
    // Suggested prompts
    document.querySelectorAll('[data-prompt]').forEach(btn => {
      btn.addEventListener('click', () => {
        input.value = btn.dataset.prompt;
        send();
      });
    });
    
    // Input handling with smooth auto-resize
    input.addEventListener('input', () => {
      const length = input.value.length;
      count.textContent = `${length}/2000`;
      
      // Auto-resize textarea
      input.style.height = 'auto';
      const newHeight = Math.min(input.scrollHeight, 100);
      input.style.height = newHeight + 'px';
      
      // Update character count color
      if (length > 1800) {
        count.classList.add('text-yellow-400');
      } else if (length > 2000) {
        count.classList.add('text-red-400');
        count.classList.remove('text-yellow-400');
      } else {
        count.classList.remove('text-yellow-400', 'text-red-400');
      }
    });
    
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
    
    sendBtn.addEventListener('click', send);
    
    voiceBtn.addEventListener('click', () => {
      addMsg('Voice input feature will be available in the next update.', 'ai');
    });
    
    // Main send function with retry logic
    async function send() {
      const msg = input.value.trim();
      if (!msg || isProcessing) return;
      
      if (msg.length > 2000) {
        addMsg('Message is too long. Please keep it under 2000 characters.', 'ai', true);
        return;
      }
      
      isProcessing = true;
      sendBtn.disabled = true;
      sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
      
      addMsg(msg, 'user');
      input.value = '';
      count.textContent = '0/2000';
      input.style.height = 'auto';
      
      const typingId = showTyping();
      retryCount = 0;
      
      try {
        const context = buildContext();
        const response = await callAPIWithRetry(msg, context);
        removeTyping(typingId);
        addMsg(response, 'ai');
      } catch (error) {
        console.error('AI Error:', error);
        removeTyping(typingId);
        
        let errorMsg = 'Unable to process your request at this time. ';
        const errText = error.message || '';
        
        if (errText.includes('quota') || errText.includes('Quota')) {
          errorMsg = 'Daily quota limit reached. The service will reset in about an hour. Please try again later or consider upgrading your API plan.';
        } else if (errText.includes('429')) {
          errorMsg += 'The service is currently experiencing high traffic. Please try again in a moment.';
        } else if (errText.includes('timeout')) {
          errorMsg += 'The request timed out. Please try again.';
        } else if (errText.includes('API key')) {
          errorMsg += 'There is an issue with the API configuration.';
        } else {
          errorMsg += 'Please check your connection and try again.';
        }
        
        addMsg(errorMsg, 'ai', true);
      } finally {
        isProcessing = false;
        sendBtn.disabled = false;
        sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
    
    // Build context from selected filters
    function buildContext() {
      let context = 'You are an Earth science AI assistant. Be concise and brief.\n\n';
      
      if (anomalies.length && !anomalies.includes('All')) {
        context += `Focus: ${anomalies.join(', ')}\n`;
      }
      
      if (layers.length) {
        context += `Layers: ${layers.join(', ')}\n`;
      }
      
      if (dateFrom.value && dateTo.value) {
        context += `Period: ${dateFrom.value} to ${dateTo.value}\n`;
      }
      
      // Add EONET anomaly data to context
      if (eonetData.length > 0) {
        context += '\nRecent Earth Anomalies (EONET Data):\n';
        eonetData.slice(0, 10).forEach(event => {
          const date = new Date(event.geometry[0].date).toLocaleDateString();
          const coords = event.geometry[0].coordinates;
          context += `- ${event.title} (${event.categories[0].title}): ${date}, Location: ${coords[1].toFixed(2)}°N, ${coords[0].toFixed(2)}°E\n`;
        });
      }
      
      context += '\nKeep responses short (2-3 sentences). Use markdown.\n\n';
      
      return context;
    }
    
    // API call with exponential backoff retry using official SDK
    async function callAPIWithRetry(message, context, delay = 1000) {
      try {
        return await callAPI(message, context);
      } catch (error) {
        const errorMsg = error.message || '';
        if ((errorMsg.includes('429') || errorMsg.includes('quota') || errorMsg.includes('rate')) && retryCount < MAX_RETRIES) {
          retryCount++;
          const waitTime = delay * Math.pow(2, retryCount - 1);
          console.log(`Retry ${retryCount}/${MAX_RETRIES} after ${waitTime}ms`);
          await new Promise(resolve => setTimeout(resolve, waitTime));
          return callAPIWithRetry(message, context, delay);
        }
        throw error;
      }
    }
    
    // API call function using Google Generative AI SDK
    async function callAPI(message, context) {
      try {
        // Combine context and message for a single request
        const fullPrompt = context + '\n\nUser Question: ' + message;
        
        // Send message with timeout
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Request timeout - please try again')), 30000)
        );
        
        const responsePromise = model.generateContent({
          contents: [{ 
            role: 'user', 
            parts: [{ text: fullPrompt }] 
          }],
          generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 512,
          },
          safetySettings: [
            {
              category: "HARM_CATEGORY_HARASSMENT",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
              category: "HARM_CATEGORY_HATE_SPEECH",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            }
          ]
        });
        
        const result = await Promise.race([responsePromise, timeoutPromise]);
        
        // Get text from response
        const response = await result.response;
        const text = response.text();
        
        if (!text) {
          throw new Error('Empty response from API');
        }
        
        return text;
      } catch (error) {
        console.error('API Error:', error);
        
        // Handle specific error types
        if (error.message?.includes('timeout')) {
          throw new Error('Request timeout - please try again');
        }
        
        if (error.message?.includes('API key')) {
          throw new Error('API key error - please check configuration');
        }
        
        throw error;
      }
    }
    
    // Add message to chat
    function addMsg(text, type, isError = false) {
      const div = document.createElement('div');
      div.className = 'flex gap-3 msg-slide';
      
      if (type === 'user') {
        div.classList.add('justify-end');
        div.innerHTML = `
          <div class="flex-1 max-w-3xl flex justify-end">
            <div class="bg-gradient-to-r from-violet-600 to-fuchsia-600 rounded-2xl rounded-tr-none px-4 py-3">
              <p class="text-sm text-white whitespace-pre-wrap">${escapeHtml(text)}</p>
            </div>
          </div>
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          </div>
        `;
      } else {
        const bgClass = isError ? 'bg-red-500/10 border border-red-500/30' : 'glass';
        div.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
          </div>
          <div class="flex-1 max-w-3xl">
            <div class="${bgClass} rounded-2xl rounded-tl-none px-4 py-3">
              <div class="text-sm text-slate-200">${formatMarkdown(text)}</div>
            </div>
            <div class="mt-2 text-xs text-slate-500">${new Date().toLocaleTimeString()}</div>
          </div>
        `;
      }
      
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      
      if (type === 'user') {
        document.getElementById('prompts')?.classList.add('hidden');
      }
    }
    
    // Show typing indicator
    function showTyping() {
      const id = 'typing-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = 'flex gap-3';
      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        </div>
        <div class="glass rounded-2xl rounded-tl-none px-4 py-3">
          <div class="typing flex gap-1">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return id;
    }
    
    // Remove typing indicator
    function removeTyping(id) {
      document.getElementById(id)?.remove();
    }
    
    // Format markdown
    function formatMarkdown(text) {
      text = escapeHtml(text);
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');
      text = text.replace(/`(.*?)`/g, '<code class="px-1.5 py-0.5 bg-slate-700/70 rounded text-xs font-mono">$1</code>');
      text = text.replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>');
      text = text.replace(/(<li>.*<\/li>)/s, '<ul class="list-disc list-inside space-y-1 my-2">$1</ul>');
      text = text.replace(/\n\n/g, '<br><br>');
      text = text.replace(/\n/g, '<br>');
      return text;
    }
    
    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Load EONET anomaly data
    async function loadEONETData() {
      try {
        const response = await fetch('https://eonet.gsfc.nasa.gov/api/v3/events?days=30&limit=50');
        const data = await response.json();
        eonetData = data.events || [];
        console.log(`Loaded ${eonetData.length} EONET events`);
      } catch (error) {
        console.error('Failed to load EONET data:', error);
        eonetData = [];
      }
    }
    
    // Refresh EONET data periodically
    setInterval(loadEONETData, 300000); // Refresh every 5 minutes
    
    console.log('AI Assistant initialized successfully');
  </script>
</body>
</html>

