<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cesium + NDVI WMS Overlay Test</title>
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../style/earth.css" />
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%2300a2ff"/><circle cx="50" cy="50" r="42" fill="%23111" opacity=".15"/></svg>' />
  <link rel="stylesheet" href="/style/earth.css" />
  <link rel="stylesheet" href="/style/earth.css" />
</head>
<body>
  <div id="cesiumContainer"></div>
  <!-- Floating IMERG legend -->
  <div id="imergLegend" class="hidden fixed z-20 pointer-events-none rounded-lg border border-white/10 bg-zinc-900/70 backdrop-blur text-zinc-100 shadow-xl p-2 w-64 md:p-3 md:w-72">
    <div class="text-xs uppercase tracking-wide text-zinc-300">Precipitation Rate (30‑min)</div>
    <div class="text-[10px] text-zinc-400 mb-2">IMERG</div>
    <div class="text-xs mb-1">Rain Rate</div>
    <div class="h-3 w-full rounded overflow-hidden border border-white/10" style="background: linear-gradient(90deg, #2ecc71, #f1c40f, #e67e22, #e74c3c, #8e44ad);"></div>
    <div class="flex justify-between text-[10px] text-zinc-400 mt-0.5">
      <span>0.1 mm/hr</span><span>≥ 53.0 mm/hr</span>
    </div>
    <div class="text-xs mt-2 mb-1">Snow Rate</div>
    <div class="h-3 w-full rounded overflow-hidden border border-white/10" style="background: linear-gradient(90deg, #aef, #7dd3fc, #60a5fa, #818cf8, #a78bfa, #c084fc);"></div>
    <div class="flex justify-between text-[10px] text-zinc-400 mt-0.5">
      <span>0.1 mm/hr</span><span>≥ 53.0 mm/hr</span>
    </div>
  </div>
  <!-- Floating layer notes (top-right stack) -->
  <div id="layerNotes" class="fixed top-14 right-3 z-10 space-y-2"></div>

  <!-- Timeline Slider (Top) -->
  <div id="timelineContainer" class="fixed top-2 left-1/2 transform -translate-x-1/2 z-10 md:top-4">
    <div class="bg-gradient-to-r from-slate-900/90 via-gray-900/90 to-slate-900/90 backdrop-blur-xl border border-white/20 rounded-2xl px-3 py-2 shadow-2xl md:rounded-3xl md:px-6 md:py-4">
      <div class="flex items-center gap-3 text-xs md:gap-6 md:text-sm">
        <!-- Time Display -->
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 animate-pulse shadow-lg"></div>
            <div class="absolute inset-0 w-3 h-3 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 animate-ping opacity-30"></div>
          </div>
          <div class="flex flex-col">
            <span id="timelineLabel" class="font-bold text-white text-sm">2024-09-29</span>
            <span class="text-xs text-gray-400">Timeline</span>
          </div>
        </div>
        
        <!-- Modern Slider -->
        <div class="flex items-center gap-4">
          <div class="relative">
            <input 
              type="range" 
              id="timelineSlider" 
              min="0" 
              max="365" 
              value="272" 
              class="w-28 h-2 bg-transparent rounded-full appearance-none cursor-pointer slider md:w-40"
            />
            <div class="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500/20 via-purple-500/20 to-pink-500/20 pointer-events-none"></div>
          </div>
          
          <!-- Date Range -->
          <div class="flex items-center gap-3 text-xs">
            <span class="px-2 py-1 rounded-full bg-gradient-to-r from-emerald-500/20 to-green-500/20 text-emerald-300 border border-emerald-500/30">Jan</span>
            <span class="text-gray-500">→</span>
            <span class="px-2 py-1 rounded-full bg-gradient-to-r from-rose-500/20 to-pink-500/20 text-rose-300 border border-rose-500/30">Dec</span>
          </div>
        </div>
        
        <!-- Modern Play Button -->
        <button id="playTimeline" class="group relative w-8 h-8 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-400 hover:to-green-400 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-emerald-500/25 hover:scale-110 active:scale-95 flex items-center justify-center md:w-10 md:h-10 md:rounded-2xl">
          <svg class="w-3 h-3 transition-transform group-hover:scale-110 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <div class="absolute inset-0 rounded-2xl bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Floating Dock (Bottom) -->
  <div class="fixed bottom-3 left-1/2 transform -translate-x-1/2 z-30 md:bottom-6">
    <div class="bg-gradient-to-r from-slate-900/90 via-gray-900/90 to-slate-900/90 backdrop-blur-xl border border-white/20 rounded-2xl px-4 py-3 shadow-2xl md:rounded-3xl md:px-6 md:py-4">
      <div class="flex items-center gap-4 text-xs md:gap-6 md:text-sm">
        <!-- Dashboard Page (Current) -->
        <button id="pageDashboard" class="group relative w-10 h-10 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-400 hover:to-green-400 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-emerald-500/25 hover:scale-110 active:scale-95 flex items-center justify-center page-active md:w-12 md:h-12 md:rounded-2xl">
          <svg class="w-4 h-4 transition-transform group-hover:scale-110 md:w-5 md:h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
          </svg>
          <div class="absolute inset-0 rounded-2xl bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs font-medium text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap">Dashboard</div>
        </button>
        
        <!-- Compare Page -->
        <button id="pageCompare" class="group relative w-10 h-10 bg-gradient-to-r from-sky-500 to-indigo-500 hover:from-sky-400 hover:to-indigo-400 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-sky-500/25 hover:scale-110 active:scale-95 flex items-center justify-center md:w-12 md:h-12 md:rounded-2xl" onclick="location.href='/public/COMPARE.html'">
          <svg class="w-4 h-4 transition-transform group-hover:scale-110 md:w-5 md:h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 7l9-4 9 4-9 4-9-4zm0 5l9 4 9-4v6l-9 4-9-4v-6z"/>
          </svg>
          <div class="absolute inset-0 rounded-2xl bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs font-medium text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap">Compare</div>
        </button>

        <!-- Prediction Page -->
        <button id="pagePrediction" class="group relative w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-400 hover:to-cyan-400 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-blue-500/25 hover:scale-110 active:scale-95 flex items-center justify-center md:w-12 md:h-12 md:rounded-2xl" onclick="location.href='/public/COMPARE.html'">
          <svg class="w-4 h-4 transition-transform group-hover:rotate-12 md:w-5 md:h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/>
          </svg>
          <div class="absolute inset-0 rounded-2xl bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs font-medium text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap">Prediction</div>
        </button>
        
        <!-- Community Page -->
        <button id="pageCommunity" class="group relative w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-purple-500/25 hover:scale-110 active:scale-95 flex items-center justify-center md:w-12 md:h-12 md:rounded-2xl">
          <svg class="w-4 h-4 transition-transform group-hover:scale-110 md:w-5 md:h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
          </svg>
          <div class="absolute inset-0 rounded-2xl bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs font-medium text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap">Community</div>
        </button>
      </div>
    </div>
  </div>
  <!-- Top-right Anomalies button -->
  <div class="fixed top-3 right-3 z-20 flex items-center gap-2 md:top-4 md:right-4">
    <button id="anomalyButton" class="group relative w-10 h-10 rounded-full bg-gradient-to-r from-rose-500/20 via-pink-500/20 to-red-500/20 hover:from-rose-500/30 hover:via-pink-500/30 hover:to-red-500/30 backdrop-blur-xl text-white shadow-2xl border border-rose-500/30 hover:border-rose-500/50 transition-all duration-300 hover:scale-110 active:scale-95 flex items-center justify-center md:w-12 md:h-12">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-transform group-hover:scale-110 md:w-6 md:h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20Zm1 14h-2v-2h2v2Zm0-4h-2V7h2v5Z"/></svg>
      <div class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full animate-pulse"></div>
    </button>
  </div>

  <!-- Anomalies side panel -->
  <div id="anomalyPanel" class="hidden fixed top-2 right-2 z-20 w-[90vw] max-w-md rounded-xl bg-zinc-900/95 text-zinc-100 shadow-2xl border border-white/10 backdrop-blur md:top-3 md:right-3 md:w-96">
    <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
      <div class="font-semibold">Anomalies</div>
      <button id="anomalyClose" class="text-zinc-300 hover:text-white">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811L4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586 6.225 4.811z"/></svg>
      </button>
    </div>
    
    <!-- Filter Buttons -->
    <div class="px-4 py-3 border-b border-white/10">
      <div class="text-sm text-zinc-300 mb-2">Filter by Type</div>
      <div class="flex flex-wrap gap-2">
        <button id="filterAll" class="px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-blue-300 border border-blue-500/30 text-xs font-medium hover:from-blue-500/30 hover:to-cyan-500/30 transition-all duration-300 active:scale-95">All</button>
        <button id="filterWildfires" class="px-3 py-1.5 rounded-full bg-gradient-to-r from-orange-500/20 to-red-500/20 text-orange-300 border border-orange-500/30 text-xs font-medium hover:from-orange-500/30 hover:to-red-500/30 transition-all duration-300 active:scale-95">Wildfires</button>
        <button id="filterFloods" class="px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-500/20 to-indigo-500/20 text-blue-300 border border-blue-500/30 text-xs font-medium hover:from-blue-500/30 hover:to-indigo-500/30 transition-all duration-300 active:scale-95">Floods</button>
        <button id="filterStorms" class="px-3 py-1.5 rounded-full bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 border border-purple-500/30 text-xs font-medium hover:from-purple-500/30 hover:to-pink-500/30 transition-all duration-300 active:scale-95">Storms</button>
        <button id="filterDust" class="px-3 py-1.5 rounded-full bg-gradient-to-r from-yellow-500/20 to-amber-500/20 text-yellow-300 border border-yellow-500/30 text-xs font-medium hover:from-yellow-500/30 hover:to-amber-500/30 transition-all duration-300 active:scale-95">Dust & Haze</button>
      </div>
    </div>
    
    <div class="px-4 py-3 space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-zinc-400 mb-1">From</label>
          <input id="anomalyFrom" type="date" class="w-full rounded-md bg-zinc-800 border border-white/10 px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-rose-500" />
        </div>
        <div>
          <label class="block text-xs text-zinc-400 mb-1">To</label>
          <input id="anomalyTo" type="date" class="w-full rounded-md bg-zinc-800 border border-white/10 px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-rose-500" />
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="anomalyApply" class="rounded-md bg-rose-600 hover:bg-rose-500 px-3 py-1.5 text-sm font-medium">Apply</button>
        <button id="anomalyReset" class="rounded-md bg-zinc-700 hover:bg-zinc-600 px-3 py-1.5 text-sm">Reset</button>
      </div>
      <div id="anomalySummary" class="text-xs text-zinc-400"></div>
      <div id="anomalyList" class="max-h-[50vh] overflow-auto divide-y divide-white/10"></div>
    </div>
  </div>

  <!-- Worldview details modal -->
  <div id="wvModal" class="hidden fixed inset-0 z-30">
    <div id="wvBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-5xl h-[75vh] rounded-xl overflow-hidden bg-zinc-950 border border-white/10 shadow-2xl relative">
        <div class="absolute top-2 right-2 flex gap-2">
          <a id="wvOpenNew" href="#" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 text-xs rounded bg-emerald-600 hover:bg-emerald-500">Open in new tab</a>
          <button id="wvClose" class="px-3 py-1.5 text-xs rounded bg-zinc-700 hover:bg-zinc-600">Close</button>
        </div>
        <iframe id="wvFrame" class="w-full h-full" src="about:blank" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>
  <!-- Top-left brand + dropdown controller -->
  <div class="fixed top-3 left-3 z-20 md:top-4 md:left-4">
    <button id="menuButton" class="group relative w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-pink-500/20 hover:from-indigo-500/30 hover:via-purple-500/30 hover:to-pink-500/30 backdrop-blur-xl text-white shadow-2xl border border-white/20 hover:border-white/30 transition-all duration-300 hover:scale-110 active:scale-95 flex items-center justify-center md:w-12 md:h-12">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 transition-transform group-hover:scale-110 md:w-6 md:h-6">
        <path d="M3 7h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
        <path d="M3 7h18v2H3V7z" transform="translate(2,2)" opacity="0.7"/>
        <path d="M3 7h18v2H3V7z" transform="translate(4,4)" opacity="0.5"/>
      </svg>
      <div class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-emerald-400 to-green-500 rounded-full animate-pulse"></div>
    </button>

    <div id="menuPanel" class="hidden mt-2 w-80 rounded-2xl bg-gradient-to-br from-slate-900/95 via-gray-900/95 to-slate-900/95 text-white shadow-2xl border border-white/20 backdrop-blur-xl overflow-hidden md:mt-3 md:w-96 md:rounded-3xl">
      <div class="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-blue-500/10 to-purple-500/10">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-2 h-2 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400"></div>
          <div class="text-sm font-semibold text-white">Base Layer</div>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-sm font-medium text-gray-200">BlueMarble Next Generation</div>
          <span class="text-xs px-3 py-1 rounded-full bg-gradient-to-r from-emerald-500/20 to-green-500/20 text-emerald-300 border border-emerald-500/30">Always Active</span>
        </div>
      </div>

      <div class="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-purple-500/10 to-pink-500/10">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-2 h-2 rounded-full bg-gradient-to-r from-purple-400 to-pink-400"></div>
          <div class="text-sm font-semibold text-white">Data Layers</div>
        </div>
        <div class="space-y-3">
          <label class="group flex items-center justify-between gap-4 p-3 rounded-xl bg-gradient-to-r from-gray-800/50 to-gray-700/50 hover:from-gray-700/50 hover:to-gray-600/50 border border-white/10 hover:border-white/20 transition-all duration-300 cursor-pointer">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center shadow-lg">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <div>
                <div class="text-sm font-medium text-white">Place Labels</div>
                <div class="text-xs text-gray-400">Geographic markers</div>
              </div>
            </div>
            <input id="toggleLabels" type="checkbox" class="peer sr-only" checked>
            <div class="relative w-12 h-6 rounded-full bg-gradient-to-r from-gray-600 to-gray-700 peer-checked:from-emerald-500 peer-checked:to-green-500 transition-all duration-300 shadow-inner">
              <div class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white shadow-lg transition-transform duration-300 peer-checked:translate-x-6"></div>
            </div>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Settlements (GRUMP)</span>
            <input id="toggleSettlements" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Cloud Top Pressure (Aqua)</span>
            <input id="toggleCloudPressure" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">CERES Longwave Flux</span>
            <input id="toggleCeresFlux" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">MOPITT CO (Terra)</span>
            <input id="toggleMopitt" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">NDVI (MODIS Terra 8-Day)</span>
            <input id="toggleNdvi" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Land Surface Temp (Terra)</span>
            <input id="toggleLst" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">GEDI Biomass (Mean)</span>
            <input id="toggleGedi" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Carbon Monoxide (AIRS 500 hPa)</span>
            <input id="toggleCO" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Radiance (MISR Infrared Color Monthly)</span>
            <input id="toggleMISR" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
        </div>
      </div>

      <div class="px-4 py-3">
        <div class="text-sm text-zinc-300 mb-2">EONET Events (2020–2025)</div>
        <div class="space-y-2">
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Wildfires</span>
            <input id="toggleEonetWild" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Floods</span>
            <input id="toggleEonetFloods" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Dust & Haze</span>
            <input id="toggleEonetDust" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
          <label class="flex items-center justify-between gap-3">
            <span class="text-sm">Severe Storms</span>
            <input id="toggleEonetStorms" type="checkbox" class="peer sr-only">
            <span class="w-10 h-6 rounded-full bg-zinc-700 peer-checked:bg-emerald-600 relative transition">
              <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition peer-checked:translate-x-4"></span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden links to keep JS href wiring intact -->
  <div class="hidden">
    <a id="src" href="#"></a>
    <a id="srcBaseBmng" href="#"></a>
    <a id="srcLst" href="#"></a>
    <a id="srcGedi" href="#"></a>
    <a id="srcEonetWild" href="#"></a>
    <a id="srcEonetFloods" href="#"></a>
    <a id="srcEonetDust" href="#"></a>
    <a id="srcEonetStorms" href="#"></a>
    <span id="dateLabel"></span>
    <span id="alphaLabel"></span>
    <span id="status"></span>
  </div>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <script src="/script/earth.js"></script>
      // Tailwind dropdown toggle
      const menuBtn = document.getElementById('menuButton');
      const menuPanel = document.getElementById('menuPanel');
      function closeOnOutside(event) {
        if (!menuPanel.contains(event.target) && !menuBtn.contains(event.target)) {
          menuPanel.classList.add('hidden');
          document.removeEventListener('click', closeOnOutside);
        }
      }
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuPanel.classList.toggle('hidden');
        if (!menuPanel.classList.contains('hidden')) {
          setTimeout(() => document.addEventListener('click', closeOnOutside), 0);
        }
      });
      if (typeof Cesium === 'undefined') {
        alert('Cesium failed to load. Check your network.');
        return;
      }

      // Create viewer with no default imagery
      const viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: false,
        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
        timeline: false,
        animation: false,
        homeButton: false,
        sceneModePicker: false,
        baseLayerPicker: false,
        navigationHelpButton: false,
        fullscreenButton: false,
        vrButton: false,
        geocoder: false,
        infoBox: false,
        selectionIndicator: false
      });

      // Hide default credits
      if (viewer && viewer.cesiumWidget && viewer.cesiumWidget.creditContainer) {
        viewer.cesiumWidget.creditContainer.style.display = 'none';
      }

      // Gentle auto-rotate until user zooms
      let autoRotateEnabled = true;
      const rotateRadiansPerSec = Cesium.Math.toRadians(2.0); // 2 deg/sec
      function autoRotateTick(clock) {
        if (!autoRotateEnabled) return;
        const dt = clock.deltaTime || 0;
        const dLon = rotateRadiansPerSec * dt;
        try {
          const cam = viewer.camera;
          const c = cam.positionCartographic.clone();
          const newLon = c.longitude + dLon;
          cam.setView({
            destination: Cesium.Cartesian3.fromRadians(newLon, c.latitude, c.height),
            orientation: { heading: cam.heading, pitch: cam.pitch, roll: cam.roll }
          });
        } catch (_) {}
      }
      viewer.clock.onTick.addEventListener(autoRotateTick);

      // Stop rotation on zoom interactions (wheel or pinch)
      const inputHandler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
      inputHandler.setInputAction(() => { autoRotateEnabled = false; }, Cesium.ScreenSpaceEventType.WHEEL);
      inputHandler.setInputAction(() => { autoRotateEnabled = false; }, Cesium.ScreenSpaceEventType.PINCH_START);
      inputHandler.setInputAction(() => { autoRotateEnabled = false; }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
      inputHandler.setInputAction(() => { autoRotateEnabled = false; }, Cesium.ScreenSpaceEventType.RIGHT_DOWN);

      // Base tiles: BlueMarble Next Generation (WMS, always visible)
      const bmngDate = '2025-09-25';
      const baseBmngWms = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'BlueMarble_NextGeneration',
        parameters: {
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          styles: '',
          format: 'image/png',
          transparent: false,
          time: bmngDate
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const baseBmngLayer = viewer.imageryLayers.addImageryProvider(baseBmngWms);
      baseBmngLayer.alpha = 1.0;
      baseBmngLayer.show = true; // always on

      // Reference Labels (Place labels)
      const labelsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'Reference_Labels_15m',
        parameters: { service: 'WMS', request: 'GetMap', version: '1.3.0', styles: '', format: 'image/png', transparent: true },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const labelsLayer = viewer.imageryLayers.addImageryProvider(labelsProvider);
      labelsLayer.alpha = 1.0;
      labelsLayer.show = true;

      // GRUMP Settlements
      const settlementsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'GRUMP_Settlements',
        parameters: { service: 'WMS', request: 'GetMap', version: '1.3.0', styles: '', format: 'image/png', transparent: true },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const settlementsLayer = viewer.imageryLayers.addImageryProvider(settlementsProvider);
      settlementsLayer.alpha = 1.0;
      settlementsLayer.show = false;

      // MODIS Aqua Cloud Top Pressure Day
      const cloudPressureProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'MODIS_Aqua_Cloud_Top_Pressure_Day',
        parameters: { service: 'WMS', request: 'GetMap', version: '1.3.0', styles: '', format: 'image/png', transparent: true },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const cloudPressureLayer = viewer.imageryLayers.addImageryProvider(cloudPressureProvider);
      cloudPressureLayer.alpha = 1.0;
      cloudPressureLayer.show = false;

      // CERES EBAF TOA CRE Longwave Flux Monthly
      const ceresFluxProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'CERES_EBAF_TOA_CRE_Longwave_Flux_Monthly',
        parameters: { service: 'WMS', request: 'GetMap', version: '1.3.0', styles: '', format: 'image/png', transparent: true },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const ceresFluxLayer = viewer.imageryLayers.addImageryProvider(ceresFluxProvider);
      ceresFluxLayer.alpha = 1.0;
      ceresFluxLayer.show = false;

      // MOPITT CO Monthly Total Column Day
      const mopittProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'MOPITT_CO_Monthly_Total_Column_Day',
        parameters: { 
          service: 'WMS', 
          request: 'GetMap', 
          version: '1.3.0', 
          styles: '', 
          format: 'image/png', 
          transparent: true,
          crs: 'EPSG:4326',
          time: '2024-09-29T20:07:58Z'
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const mopittLayer = viewer.imageryLayers.addImageryProvider(mopittProvider);
      mopittLayer.alpha = 1.0;
      mopittLayer.show = false;

      // NDVI overlay from NASA GIBS Worldview (WMS)
      const ndviDate = '2025-09-21';
      const statusEl = document.getElementById('status');
      const ndviWmsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'MODIS_Terra_NDVI_8Day',
        parameters: {
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          styles: '',
          format: 'image/png',
          transparent: true,
          time: ndviDate
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const ndviWmsLayer = viewer.imageryLayers.addImageryProvider(ndviWmsProvider);
      ndviWmsLayer.alpha = 0.85;
      ndviWmsLayer.show = false; // start hidden

      // Land Surface Temperature (Day) WMS overlay
      const lstDate = '2025-09-29';
      const lstWmsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: 'MODIS_Terra_Land_Surface_Temp_Day',
        parameters: {
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          styles: '',
          format: 'image/png',
          transparent: true,
          time: lstDate
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const lstWmsLayer = viewer.imageryLayers.addImageryProvider(lstWmsProvider);
      lstWmsLayer.alpha = 0.85;
      lstWmsLayer.show = false; // start hidden until toggled on

      // GEDI Aboveground Biomass Density (Mean) WMS overlay
      const gediDate = '2022-11-15';
      const gediLayerName = 'GEDI_ISS_L4B_Aboveground_Biomass_Density_Mean_201904-202303';
      const gediWmsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: gediLayerName,
        parameters: {
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          styles: '',
          format: 'image/png',
          transparent: true,
          time: gediDate
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const gediWmsLayer = viewer.imageryLayers.addImageryProvider(gediWmsProvider);
      gediWmsLayer.alpha = 0.85;
      gediWmsLayer.show = false; // off by default

      // AIRS Carbon Monoxide (500 hPa) — Day
      const coDateTime = '2025-06-30T02:30:00Z';
      const coLayerName = 'AIRS_L2_Carbon_Monoxide_500hPa_Volume_Mixing_Ratio_Day';
      const coWmsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: coLayerName,
        parameters: {
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          styles: '',
          format: 'image/png',
          transparent: true,
          time: coDateTime
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const coWmsLayer = viewer.imageryLayers.addImageryProvider(coWmsProvider);
      coWmsLayer.alpha = 0.85;
      coWmsLayer.show = false;

      // MISR Radiance Average Infrared Color Monthly
      const misrDateTime = '2019-09-07T15:25:24Z';
      const misrLayerName = 'MISR_Radiance_Average_Infrared_Color_Monthly';
      const misrWmsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
        layers: misrLayerName,
        parameters: {
          service: 'WMS',
          request: 'GetMap',
          version: '1.3.0',
          styles: '',
          format: 'image/png',
          transparent: true,
          time: misrDateTime
        },
        tilingScheme: new Cesium.GeographicTilingScheme()
      });
      const misrWmsLayer = viewer.imageryLayers.addImageryProvider(misrWmsProvider);
      misrWmsLayer.alpha = 0.85;
      misrWmsLayer.show = false;

      // IMERG Precipitation 30-min WMS overlay (created hidden; updated per storm anomaly click)
      let imergWmsLayer = null;
      function addOrUpdateIMERGLayer(dateISO) {
        const timeStr = (new Date(dateISO)).toISOString().slice(0,10);
        try {
          if (imergWmsLayer) {
            viewer.imageryLayers.remove(imergWmsLayer, false);
            imergWmsLayer = null;
          }
        } catch(_) {}

        const imergProvider = new Cesium.WebMapServiceImageryProvider({
          url: 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi',
          layers: 'IMERG_Precipitation_Rate_30min',
          parameters: {
            service: 'WMS',
            request: 'GetMap',
            version: '1.3.0',
            styles: '',
            format: 'image/png',
            transparent: true,
            time: timeStr
          },
          tilingScheme: new Cesium.GeographicTilingScheme()
        });
        imergWmsLayer = viewer.imageryLayers.addImageryProvider(imergProvider);
        imergWmsLayer.alpha = 0.8;
        imergWmsLayer.show = true;
        try { viewer.imageryLayers.raiseToTop(imergWmsLayer); } catch(_) {}
        showLayerNote('imerg', `IMERG — Precipitation rate (30‑min) at ${timeStr}.`);
      }

      // Floating legend anchor and visibility management
      const LEGEND_HIDE_HEIGHT = 15000000; // 15,000 km
      const legendAnchor = { lon: null, lat: null };

      function updateLegend() {
        const legend = document.getElementById('imergLegend');
        if (legendAnchor.lon === null || legendAnchor.lat === null) { legend.classList.add('hidden'); return; }
        const height = viewer.camera.positionCartographic.height;
        if (height > LEGEND_HIDE_HEIGHT) { legend.classList.add('hidden'); return; }
        const cartesian = Cesium.Cartesian3.fromDegrees(legendAnchor.lon, legendAnchor.lat);
        const windowPos = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, cartesian);
        if (!windowPos) { legend.classList.add('hidden'); return; }
        // If too close to screen edges, hide (optional)
        if (windowPos.x < 0 || windowPos.y < 0 || windowPos.x > window.innerWidth || windowPos.y > window.innerHeight) {
          legend.classList.add('hidden');
          return;
        }
        legend.style.left = `${Math.round(windowPos.x) + 12}px`;
        legend.style.top = `${Math.round(windowPos.y) - 12}px`;
        legend.classList.remove('hidden');
      }

      function positionLegendAt(lon, lat) {
        legendAnchor.lon = lon;
        legendAnchor.lat = lat;
        updateLegend();
      }

      // Keep legend updated while navigating
      viewer.scene.postRender.addEventListener(updateLegend);

      // Basic lighting for nice visuals
      viewer.scene.globe.enableLighting = true;
      viewer.clock.shouldAnimate = true;

      // UI wires
      const srcLink = document.getElementById('src');
      const dateLabel = document.getElementById('dateLabel');
      const alphaLabel = document.getElementById('alphaLabel');
      const wmsGetMap = `https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS&REQUEST=GetMap&VERSION=1.3.0&LAYERS=MODIS_Terra_NDVI_8Day&CRS=EPSG:4326&BBOX=-180,-90,180,90&WIDTH=1200&HEIGHT=600&FORMAT=image/png&TIME=${ndviDate}`;
      srcLink.href = wmsGetMap;
      dateLabel.textContent = ndviDate;
      alphaLabel.textContent = String(ndviWmsLayer.alpha);

      const srcBaseBmng = document.getElementById('srcBaseBmng');
      const bmngGetMap = `https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS&REQUEST=GetMap&VERSION=1.3.0&LAYERS=BlueMarble_NextGeneration&CRS=EPSG:4326&BBOX=-180,-90,180,90&WIDTH=1200&HEIGHT=600&FORMAT=image/png&TIME=${bmngDate}`;
      srcBaseBmng.href = bmngGetMap;

      const srcLst = document.getElementById('srcLst');
      const lstGetMap = `https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS&REQUEST=GetMap&VERSION=1.3.0&LAYERS=MODIS_Terra_Land_Surface_Temp_Day&CRS=EPSG:4326&BBOX=-180,-90,180,90&WIDTH=1200&HEIGHT=600&FORMAT=image/png&TIME=${lstDate}`;
      srcLst.href = lstGetMap;

      const srcGedi = document.getElementById('srcGedi');
      const gediGetMap = `https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS&REQUEST=GetMap&VERSION=1.3.0&LAYERS=${gediLayerName}&CRS=EPSG:4326&BBOX=-180,-90,180,90&WIDTH=1200&HEIGHT=600&FORMAT=image/png&TIME=${gediDate}`;
      srcGedi.href = gediGetMap;

      // Toggle handlers
      const toggleNdvi = document.getElementById('toggleNdvi');
      const toggleLst = document.getElementById('toggleLst');
      const toggleGedi = document.getElementById('toggleGedi');
      const toggleCO = document.getElementById('toggleCO');
      const toggleMISR = document.getElementById('toggleMISR');
      const toggleLabels = document.getElementById('toggleLabels');
      const toggleSettlements = document.getElementById('toggleSettlements');
      const toggleCloudPressure = document.getElementById('toggleCloudPressure');
      const toggleCeresFlux = document.getElementById('toggleCeresFlux');
      const toggleMopitt = document.getElementById('toggleMopitt');
      // Labels toggle
      toggleLabels.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleLabels.checked;
        labelsLayer.show = checked;
      });

      // Settlements toggle
      toggleSettlements.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleSettlements.checked;
        settlementsLayer.show = checked;
        if (checked) {
          showLayerNote('settlements');
        } else {
          hideLayerNote('settlements');
        }
      });

      // Cloud Pressure toggle
      toggleCloudPressure.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleCloudPressure.checked;
        cloudPressureLayer.show = checked;
        if (checked) {
          showLayerNote('cloudPressure');
        } else {
          hideLayerNote('cloudPressure');
        }
      });

      // CERES Flux toggle
      toggleCeresFlux.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleCeresFlux.checked;
        ceresFluxLayer.show = checked;
        if (checked) {
          showLayerNote('ceresFlux');
        } else {
          hideLayerNote('ceresFlux');
        }
      });

      // MOPITT toggle
      toggleMopitt.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleMopitt.checked;
        mopittLayer.show = checked;
        if (checked) {
          showLayerNote('mopitt');
        } else {
          hideLayerNote('mopitt');
        }
      });
      // Timeline functionality
      const timelineSlider = document.getElementById('timelineSlider');
      const timelineLabel = document.getElementById('timelineLabel');
      const playButton = document.getElementById('playTimeline');
      let isPlaying = false;
      let playInterval = null;

      // Convert day of year to date string
      function dayOfYearToDate(dayOfYear, year = 2024) {
        const date = new Date(year, 0, dayOfYear);
        return date.toISOString().split('T')[0];
      }

      // Update timeline display
      function updateTimeline() {
        const dayOfYear = parseInt(timelineSlider.value);
        const dateStr = dayOfYearToDate(dayOfYear);
        timelineLabel.textContent = dateStr;
        
        // Update layers with new time
        updateLayersWithTime(dateStr);
      }

      // Update layers with new time parameter
      function updateLayersWithTime(dateStr) {
        // Update NDVI layer
        if (ndviLayer && ndviLayer.show) {
          ndviLayer.imageryProvider.parameters.time = dateStr;
        }
        
        // Update LST layer
        if (lstLayer && lstLayer.show) {
          lstLayer.imageryProvider.parameters.time = dateStr;
        }
        
        // Update Cloud Pressure layer
        if (cloudPressureLayer && cloudPressureLayer.show) {
          cloudPressureLayer.imageryProvider.parameters.time = dateStr;
        }
        
        // Update MOPITT layer
        if (mopittLayer && mopittLayer.show) {
          mopittLayer.imageryProvider.parameters.time = dateStr + 'T20:07:58Z';
        }
      }

      // Timeline slider event
      timelineSlider.addEventListener('input', updateTimeline);

      // Play/pause functionality
      playButton.addEventListener('click', () => {
        if (isPlaying) {
          clearInterval(playInterval);
          playButton.textContent = '▶ Play';
          isPlaying = false;
        } else {
          playInterval = setInterval(() => {
            const currentValue = parseInt(timelineSlider.value);
            if (currentValue >= 365) {
              timelineSlider.value = 0;
            } else {
              timelineSlider.value = currentValue + 1;
            }
            updateTimeline();
          }, 100); // Update every 100ms
          playButton.textContent = '⏸ Pause';
          isPlaying = true;
        }
      });

      // Layer note helpers (detailed)
      const layerNoteMeta = {
        ndvi: { title: 'NDVI (Vegetation Greenness)', desc: 'Normalized Difference Vegetation Index from MODIS Terra. Higher values indicate greener, denser vegetation.', cadence: '8‑day composite', units: 'unitless (−1 to 1)', source: 'NASA GIBS / MODIS Terra', link: 'https://wiki.earthdata.nasa.gov/display/GIBS' },
        lst: { title: 'Land Surface Temperature (Day)', desc: 'Estimated land skin temperature under daytime conditions from MODIS Terra.', cadence: 'daily', units: 'Kelvin (colorized)', source: 'NASA GIBS / MODIS Terra', link: 'https://wiki.earthdata.nasa.gov/display/GIBS' },
        gedi: { title: 'GEDI Aboveground Biomass Density (Mean)', desc: 'Spatially aggregated biomass density from GEDI lidar footprints (2019–2023 mean).', cadence: 'multi‑year mean', units: 'Mg/ha', source: 'NASA GIBS / GEDI L4B', link: 'https://gedi.umd.edu/' },
        co: { title: 'Carbon Monoxide @ 500 hPa (Day)', desc: 'AIRS L2 CO volume mixing ratio at ~500 hPa. Useful for pollution and fire plume tracking.', cadence: 'orbit granules', units: 'ppbv (colorized)', source: 'NASA GIBS / AIRS L2', link: 'https://airs.jpl.nasa.gov/' },
        misr: { title: 'MISR Infrared Color Radiance (Monthly Avg)', desc: 'MISR monthly average radiance composited in infrared color.', cadence: 'monthly', units: 'radiance (colorized)', source: 'NASA GIBS / MISR', link: 'https://misr.jpl.nasa.gov/' },
        imerg: { title: 'IMERG Precipitation Rate (30‑min)', desc: 'Near‑real‑time precipitation rate from GPM IMERG highlighting rain/snow intensity.', cadence: '30‑minute', units: 'mm/hr', source: 'NASA GIBS / GPM IMERG', link: 'https://gpm.nasa.gov/data/imerg' },
        settlements: { title: 'GRUMP Settlements', desc: 'Global Rural‑Urban Mapping Project settlement locations showing human population centers worldwide.', cadence: 'static', units: 'point locations', source: 'NASA GIBS / GRUMP', link: 'https://sedac.ciesin.columbia.edu/data/collection/grump-v1' },
        cloudPressure: { title: 'Cloud Top Pressure (Aqua)', desc: 'MODIS Aqua cloud top pressure measurements during daytime. Shows atmospheric pressure at cloud tops, useful for weather analysis and storm tracking.', cadence: 'daily', units: 'hPa (colorized)', source: 'NASA GIBS / MODIS Aqua', link: 'https://wiki.earthdata.nasa.gov/display/GIBS' },
        ceresFlux: { title: 'CERES Longwave Flux (Monthly)', desc: 'CERES EBAF TOA CRE Longwave Flux Monthly shows outgoing longwave radiation at the top of the atmosphere. Essential for understanding Earth\'s energy balance and climate.', cadence: 'monthly', units: 'W/m² (colorized)', source: 'NASA GIBS / CERES EBAF', link: 'https://ceres.larc.nasa.gov/data/' },
        mopitt: { title: 'MOPITT CO Total Column (Terra)', desc: 'MOPITT CO Monthly Total Column Day shows carbon monoxide concentrations in the atmosphere. Essential for air quality monitoring and pollution tracking.', cadence: 'monthly', units: 'molecules/cm² (colorized)', source: 'NASA GIBS / MOPITT Terra', link: 'https://www2.acom.ucar.edu/mopitt' }
      };

      function renderNoteElement(key, customText) {
        const meta = layerNoteMeta[key] || { title: key, desc: customText || key };
        const div = document.createElement('div');
        div.id = `note-${key}`;
        div.className = 'pointer-events-auto rounded-lg bg-zinc-900/80 border border-white/10 text-zinc-100 shadow-md backdrop-blur px-3 py-2 text-xs max-w-xs';
        div.innerHTML = `<div class="flex items-start gap-2">
            <span class="mt-1 w-2 h-2 rounded-full bg-emerald-400"></span>
            <div class="flex-1">
              <div class="font-medium text-[11px]">${meta.title}</div>
              <div class="text-zinc-300 mt-0.5">${customText || meta.desc}</div>
              <div class="mt-1 grid grid-cols-2 gap-2 text-[10px] text-zinc-400">
                ${meta.cadence ? `<div><span class=\"text-zinc-500\">Cadence:</span> ${meta.cadence}</div>` : ''}
                ${meta.units ? `<div><span class=\"text-zinc-500\">Units:</span> ${meta.units}</div>` : ''}
                ${meta.source ? `<div class=\"col-span-2\"><span class=\"text-zinc-500\">Source:</span> ${meta.source}</div>` : ''}
              </div>
              ${meta.link ? `<div class="mt-1"><a href="${meta.link}" target="_blank" rel="noopener noreferrer" class="text-emerald-300 hover:underline">Learn more</a></div>` : ''}
            </div>
            <button data-close="${key}" class="ml-2 text-zinc-400 hover:text-white">×</button>
          </div>`;
        div.querySelector('button[data-close]')?.addEventListener('click', () => hideLayerNote(key));
        return div;
      }

      function showLayerNote(key, customText) {
        const host = document.getElementById('layerNotes');
        const existing = document.getElementById(`note-${key}`);
        if (existing) { existing.remove(); }
        host.appendChild(renderNoteElement(key, customText));
      }

      function hideLayerNote(key) {
        const el = document.getElementById(`note-${key}`);
        if (el) el.classList.add('hidden');
      }
      const toggleEonetWild = document.getElementById('toggleEonetWild');
      const toggleEonetFloods = document.getElementById('toggleEonetFloods');
      const toggleEonetDust = document.getElementById('toggleEonetDust');
      const toggleEonetStorms = document.getElementById('toggleEonetStorms');
      // No base layer toggle; BlueMarble is fixed
      toggleNdvi.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleNdvi.checked;
        ndviWmsLayer.show = checked;
        checked ? showLayerNote('ndvi') : hideLayerNote('ndvi');
      });
      toggleLst.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleLst.checked;
        lstWmsLayer.show = checked;
        checked ? showLayerNote('lst') : hideLayerNote('lst');
      });
      toggleGedi.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleGedi.checked;
        gediWmsLayer.show = checked;
        checked ? showLayerNote('gedi') : hideLayerNote('gedi');
      });
      toggleCO.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleCO.checked;
        coWmsLayer.show = checked;
        checked ? showLayerNote('co') : hideLayerNote('co');
      });
      toggleMISR.addEventListener('change', (e) => {
        const checked = (e.target && e.target.checked) ? e.target.checked : toggleMISR.checked;
        misrWmsLayer.show = checked;
        checked ? showLayerNote('misr') : hideLayerNote('misr');
      });

      // EONET overlays (points/polygons) for multiple categories
      function svgBillboard(fill) {
        return {
          image: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">\n' +
            `  <circle cx="12" cy="12" r="8" fill="${fill}" />` +
            '</svg>'
          ),
          verticalOrigin: Cesium.VerticalOrigin.CENTER,
          scale: 1.0
        };
      }

      function addEventEntityTo(ds, evt, polygonColor, pointBillboard) {
        const title = (evt && evt.title) ? evt.title : 'Event';
        const geoms = evt && evt.geometry ? evt.geometry : [];
        geoms.forEach(g => {
          const coords = g.coordinates;
          const dateStr = g.date || '';
          if (!coords) return;
          if (typeof coords[0] === 'number' && typeof coords[1] === 'number') {
            const lon = coords[0];
            const lat = coords[1];
            ds.entities.add({
              position: Cesium.Cartesian3.fromDegrees(lon, lat),
              billboard: pointBillboard,
              name: title,
              description: `${title}<br/>${dateStr}<br/>[${lon.toFixed(2)}, ${lat.toFixed(2)}]`
            });
          } else if (Array.isArray(coords)) {
            try {
              const ring = coords[0];
              const flat = [];
              for (let i = 0; i < ring.length; i++) {
                const p = ring[i];
                if (Array.isArray(p) && typeof p[0] === 'number' && typeof p[1] === 'number') {
                  flat.push(p[0], p[1]);
                }
              }
              if (flat.length >= 6) {
                ds.entities.add({
                  name: title,
                  description: `${title}<br/>${dateStr}`,
                  polygon: {
                    hierarchy: Cesium.Cartesian3.fromDegreesArray(flat),
                    material: polygonColor.withAlpha(0.35),
                    outline: true,
                    outlineColor: polygonColor.withAlpha(0.7)
                  }
                });
              }
            } catch (err) {
              // ignore malformed polygon
            }
          }
        });
      }

      const eonetCfgs = [
        {
          id: 'wildfires',
          url: 'https://eonet.gsfc.nasa.gov/api/v3/events?category=wildfires&start=2020-01-01&end=2025-12-31',
          linkId: 'srcEonetWild', toggleId: 'toggleEonetWild',
          polygonColor: Cesium.Color.ORANGE, pointBillboard: svgBillboard('#ff7043')
        },
        {
          id: 'floods',
          url: 'https://eonet.gsfc.nasa.gov/api/v3/events?category=floods&start=2020-01-01&end=2025-12-31',
          linkId: 'srcEonetFloods', toggleId: 'toggleEonetFloods',
          polygonColor: Cesium.Color.CYAN, pointBillboard: svgBillboard('#00bcd4')
        },
        {
          id: 'dustHaze',
          url: 'https://eonet.gsfc.nasa.gov/api/v3/events?category=dustHaze&start=2020-01-01&end=2025-12-31',
          linkId: 'srcEonetDust', toggleId: 'toggleEonetDust',
          polygonColor: Cesium.Color.SANDYBROWN, pointBillboard: svgBillboard('#d2a679')
        },
        {
          id: 'severeStorms',
          url: 'https://eonet.gsfc.nasa.gov/api/v3/events?category=severeStorms&start=2020-01-01&end=2025-12-31',
          linkId: 'srcEonetStorms', toggleId: 'toggleEonetStorms',
          polygonColor: Cesium.Color.YELLOW, pointBillboard: svgBillboard('#ffeb3b')
        }
      ];

      const eonetDataSources = {};
      eonetCfgs.forEach(cfg => {
        const linkEl = document.getElementById(cfg.linkId);
        if (linkEl) linkEl.href = cfg.url;
        const ds = new Cesium.CustomDataSource('eonet-' + cfg.id);
        viewer.dataSources.add(ds);
        ds.show = false;
        eonetDataSources[cfg.id] = ds;
        fetch(cfg.url)
          .then(r => r.json())
          .then(json => {
            const events = json && json.events ? json.events : [];
            events.forEach(evt => addEventEntityTo(ds, evt, cfg.polygonColor, cfg.pointBillboard));
            // Store for anomaly list
            try { window.__allAnomalies = window.__allAnomalies || []; } catch(_) {}
            const pushSafe = (rec) => { try { window.__allAnomalies.push(rec); } catch(_) {} };
            events.forEach(evt => {
              const title = evt.title || 'Event';
              const geoms = Array.isArray(evt.geometry) ? evt.geometry : [];
              geoms.forEach(g => {
                const when = g.date || '';
                const coords = g.coordinates;
                let lat = null, lon = null;
                if (Array.isArray(coords) && typeof coords[0] === 'number' && typeof coords[1] === 'number') {
                  lon = coords[0]; lat = coords[1];
                }
                pushSafe({ category: cfg.id, title, date: when, lon, lat });
              });
            });
          })
          .catch(() => {});
        const toggleEl = document.getElementById(cfg.toggleId);
        if (toggleEl) {
          toggleEl.addEventListener('change', (e) => {
            const checked = (e.target && e.target.checked) ? e.target.checked : toggleEl.checked;
            ds.show = checked;
          });
        }
      });

      // Anomalies panel logic
      const anomalyBtn = document.getElementById('anomalyButton');
      const anomalyPanel = document.getElementById('anomalyPanel');
      const anomalyClose = document.getElementById('anomalyClose');
      const anomalyFrom = document.getElementById('anomalyFrom');
      const anomalyTo = document.getElementById('anomalyTo');
      const anomalyApply = document.getElementById('anomalyApply');
      const anomalyReset = document.getElementById('anomalyReset');
      const anomalyList = document.getElementById('anomalyList');
      const anomalySummary = document.getElementById('anomalySummary');
      
      // Filter buttons
      const filterAll = document.getElementById('filterAll');
      const filterWildfires = document.getElementById('filterWildfires');
      const filterFloods = document.getElementById('filterFloods');
      const filterStorms = document.getElementById('filterStorms');
      const filterDust = document.getElementById('filterDust');
      
      let currentFilter = 'all';

      function toggleAnomalyPanel(forceOpen) {
        const willOpen = forceOpen === true ? true : (forceOpen === false ? false : anomalyPanel.classList.contains('hidden'));
        if (willOpen) {
          anomalyPanel.classList.remove('hidden');
        } else {
          anomalyPanel.classList.add('hidden');
        }
      }
      anomalyBtn.addEventListener('click', () => toggleAnomalyPanel(true));
      anomalyClose.addEventListener('click', () => toggleAnomalyPanel(false));
      
      // Filter button event listeners
      function setActiveFilter(filter) {
        currentFilter = filter;
        
        // Update button states
        [filterAll, filterWildfires, filterFloods, filterStorms, filterDust].forEach(btn => {
          btn.classList.remove('active');
          btn.classList.add('opacity-60');
        });
        
        const activeBtn = {
          'all': filterAll,
          'wildfires': filterWildfires,
          'floods': filterFloods,
          'storms': filterStorms,
          'dust': filterDust
        }[filter];
        
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.classList.remove('opacity-60');
        }
        
        renderAnomalies();
      }
      
      filterAll.addEventListener('click', () => setActiveFilter('all'));
      filterWildfires.addEventListener('click', () => setActiveFilter('wildfires'));
      filterFloods.addEventListener('click', () => setActiveFilter('floods'));
      filterStorms.addEventListener('click', () => setActiveFilter('storms'));
      filterDust.addEventListener('click', () => setActiveFilter('dust'));
      
      // Page navigation
      const pageDashboard = document.getElementById('pageDashboard');
      const pagePrediction = document.getElementById('pagePrediction');
      const pageCommunity = document.getElementById('pageCommunity');
      
      let currentPage = 'dashboard';
      
      function setActivePage(page) {
        currentPage = page;
        
        // Update button states
        [pageDashboard, pagePrediction, pageCommunity].forEach(btn => {
          btn.classList.remove('page-active');
          btn.classList.add('opacity-60');
        });
        
        const activeBtn = {
          'dashboard': pageDashboard,
          'prediction': pagePrediction,
          'community': pageCommunity
        }[page];
        
        if (activeBtn) {
          activeBtn.classList.add('page-active');
          activeBtn.classList.remove('opacity-60');
        }
        
        // Handle page-specific functionality
        handlePageChange(page);
      }
      
      function handlePageChange(page) {
        switch(page) {
          case 'dashboard':
            // Current Earth visualization page - no changes needed
            console.log('Dashboard page active');
            break;
          case 'prediction':
            // Future prediction page functionality
            console.log('Prediction page - coming soon');
            alert('Prediction page is coming soon! This will include weather forecasting, climate predictions, and environmental modeling.');
            break;
          case 'community':
            // Future community page functionality
            console.log('Community page - coming soon');
            alert('Community page is coming soon! This will include user discussions, shared visualizations, and collaborative research tools.');
            break;
        }
      }
      
      pageDashboard.addEventListener('click', () => setActivePage('dashboard'));
      pagePrediction.addEventListener('click', () => setActivePage('prediction'));
      pageCommunity.addEventListener('click', () => setActivePage('community'));

      function parseDateSafe(s) { const d = new Date(s); return isNaN(d.getTime()) ? null : d; }

      function renderAnomalies() {
        const all = Array.isArray(window.__allAnomalies) ? window.__allAnomalies : [];
        const fromD = parseDateSafe(anomalyFrom.value);
        const toD = parseDateSafe(anomalyTo.value);
        const filtered = all.filter(rec => {
          const d = parseDateSafe(rec.date);
          if (!d) return false;
          if (fromD && d < fromD) return false;
          if (toD && d > toD) return false;
          
          // Apply category filter
          if (currentFilter !== 'all') {
            const categoryMap = {
              'wildfires': 'wildfires',
              'floods': 'floods', 
              'storms': 'severeStorms',
              'dust': 'dustHaze'
            };
            if (rec.category !== categoryMap[currentFilter]) return false;
          }
          
          return true;
        }).sort((a,b) => new Date(b.date) - new Date(a.date));

        anomalySummary.textContent = `${filtered.length} event(s)`;
        anomalyList.innerHTML = '';
        filtered.forEach(rec => {
          const row = document.createElement('div');
          row.className = 'py-2 px-1 hover:bg-white/5';
          const catColor = {
            wildfires: 'bg-orange-500', floods: 'bg-cyan-500', dustHaze: 'bg-amber-600', severeStorms: 'bg-yellow-400'
          }[rec.category] || 'bg-zinc-500';
          row.innerHTML = `
            <div class="flex items-start gap-2">
              <span class="mt-1 w-2 h-2 rounded-full ${catColor}"></span>
              <div class="flex-1">
                <div class="text-sm font-medium">${rec.title}</div>
                <div class="text-xs text-zinc-400">${rec.category} • ${rec.date}</div>
                ${typeof rec.lat === 'number' && typeof rec.lon === 'number' ? `<div class="text-xs text-zinc-500">[${rec.lon.toFixed(2)}, ${rec.lat.toFixed(2)}]</div>` : ''}
              </div>
              <div class="flex flex-col items-end gap-1">
                ${typeof rec.lat === 'number' && typeof rec.lon === 'number' ? `<button class="text-xs px-2 py-1 rounded bg-zinc-700 hover:bg-zinc-600" data-goto="${rec.lon},${rec.lat}" data-category="${rec.category}" data-date="${rec.date}">Fly</button>` : ''}
                ${typeof rec.lat === 'number' && typeof rec.lon === 'number' ? `<button class="text-xs px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600" data-details="${rec.category}|${rec.date}|${rec.lon},${rec.lat}|${encodeURIComponent(rec.title)}">Details</button>` : ''}
              </div>
            </div>`;
          anomalyList.appendChild(row);
        });

        // Wire fly buttons
        anomalyList.querySelectorAll('button[data-goto]').forEach(btn => {
          btn.addEventListener('click', () => {
            const [lonStr, latStr] = btn.getAttribute('data-goto').split(',');
            const lon = parseFloat(lonStr), lat = parseFloat(latStr);
            if (!isNaN(lon) && !isNaN(lat)) {
              viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1500000) });
              // Position floating legend near target
              setTimeout(() => positionLegendAt(lon, lat), 400);
            }

            // Enable IMERG for Severe Storms category using explicit data-* attributes
            const category = btn.getAttribute('data-category');
            const dateISO = btn.getAttribute('data-date');
            if (category === 'severeStorms' && dateISO) {
              addOrUpdateIMERGLayer(dateISO);
            }
          });
        });

        // Wire details buttons to open NASA Worldview (open in new tab due to CSP)
        anomalyList.querySelectorAll('button[data-details]').forEach(btn => {
          btn.addEventListener('click', () => {
            const payload = btn.getAttribute('data-details');
            if (!payload) return;
            const [category, dateStr, coordsStr, titleEnc] = payload.split('|');
            const [lonStr, latStr] = (coordsStr || '').split(',');
            const lon = parseFloat(lonStr), lat = parseFloat(latStr);
            const title = decodeURIComponent(titleEnc || 'Event');
            if (isNaN(lon) || isNaN(lat)) return;

            const span = 12; // degrees half-span
            const minLon = Math.max(-180, lon - span);
            const maxLon = Math.min(180, lon + span);
            const minLat = Math.max(-90, lat - span/2);
            const maxLat = Math.min(90, lat + span/2);

            const trueColor = 'VIIRS_NOAA21_CorrectedReflectance_TrueColor';
            const precip = 'IMERG_Precipitation_Rate_30min';
            const labels = 'Reference_Labels_15m';
            const features = 'Reference_Features_15m';
            const coast = 'Coastlines_15m(hidden)';
            const showPrecip = (category === 'severeStorms' || category === 'floods');
            const layers = [labels, features, coast, trueColor].concat(showPrecip ? [precip] : []);

            const t = (new Date(dateStr)).toISOString().slice(0,10) + '-T00%3A00%3A00Z';
            const v = `${minLon},${minLat},${maxLon},${maxLat}`;
            const worldviewUrl = `https://worldview.earthdata.nasa.gov/?v=${encodeURIComponent(v)}&z=4&ics=true&ici=5&icd=30&l=${encodeURIComponent(layers.join(','))}&lg=false&t=${t}`;

            window.open(worldviewUrl, '_blank', 'noopener,noreferrer');
          });
        });
      }

      anomalyApply.addEventListener('click', renderAnomalies);
      anomalyReset.addEventListener('click', () => { anomalyFrom.value = ''; anomalyTo.value = ''; renderAnomalies(); });

      // Prefill default date range to last 90 days
      const now = new Date();
      const past = new Date(now.getTime() - 90*24*60*60*1000);
      anomalyTo.value = now.toISOString().slice(0,10);
      anomalyFrom.value = past.toISOString().slice(0,10);
      // Render once data starts flowing (best-effort)
      setTimeout(renderAnomalies, 1500);

      // Worldview modal close
      const wvBackdrop = document.getElementById('wvBackdrop');
      const wvClose = document.getElementById('wvClose');
      wvBackdrop.addEventListener('click', () => document.getElementById('wvModal').classList.add('hidden'));
      wvClose.addEventListener('click', () => document.getElementById('wvModal').classList.add('hidden'));
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.getElementById('wvModal').classList.add('hidden'); });

      // Camera fly-to to ensure globe is visible
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(90, 20, 20000000)
      });

      Promise.allSettled([ndviWmsProvider.readyPromise, lstWmsProvider.readyPromise, gediWmsProvider.readyPromise])
        .then(() => { statusEl.textContent = 'ready'; })
        .catch(() => { statusEl.textContent = 'loaded with warnings'; });
    })();
  </script>
</body>
</html>


