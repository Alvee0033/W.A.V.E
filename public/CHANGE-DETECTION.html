<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Change Detection ‚Ä¢ AI-Powered Temporal Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%2300a2ff"/><circle cx="50" cy="50" r="42" fill="%23111" opacity=".15"/></svg>' />
  <style>
    * {
      font-family: 'Inter', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      min-height: 100vh;
    }
    .glass-panel {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    .change-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
      border: 1px solid rgba(239, 68, 68, 0.2);
      transition: all 0.3s ease;
    }
    .change-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.15);
    }
    .analysis-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
      border: 1px solid rgba(59, 130, 246, 0.2);
      transition: all 0.3s ease;
    }
    .analysis-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    }
    .timeline-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .comparison-container {
      height: 300px;
      border-radius: 0.75rem;
      overflow: hidden;
      position: relative;
    }
    @media (min-width: 768px) {
      .comparison-container {
        height: 400px;
      }
    }
    .timeline-slider {
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ef4444);
      transition: all 0.3s ease;
    }
    .timeline-slider::-webkit-slider-thumb {
      background: #fff;
      border: 2px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    .timeline-slider::-moz-range-thumb {
      background: #fff;
      border: 2px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }
    .animate-pulse-slow {
      animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .map-placeholder {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 0.875rem;
    }
    .map-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .map-overlay:hover {
      opacity: 1;
    }

    /* Leaflet control styling */
    .leaflet-control-zoom {
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      border-radius: 12px !important;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.95) !important;
      backdrop-filter: blur(20px) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
    }

    .leaflet-control-zoom a {
      background: transparent !important;
      color: white !important;
      border: none !important;
      width: 40px !important;
      height: 40px !important;
      line-height: 40px !important;
      font-size: 20px !important;
      font-weight: 500 !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    .leaflet-control-zoom a:hover {
      background: rgba(239, 68, 68, 0.25) !important;
      transform: scale(1.05);
    }

    .leaflet-control-zoom a:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body class="gradient-bg text-white min-h-screen">
  <!-- Navigation Header -->
  <nav class="glass-panel border-b border-slate-700/50 px-4 py-4 md:px-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3 md:gap-4">
        <a href="/public/EARTH.html" class="flex items-center gap-2 text-emerald-400 hover:text-emerald-300 transition-all duration-200 hover:scale-105">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
          </svg>
          <span class="text-sm font-medium hidden sm:inline">Back to Earth</span>
        </a>
        <div class="h-6 w-px bg-slate-600 hidden md:block"></div>
        <div>
          <h1 class="text-lg md:text-xl font-bold bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">Change Detection</h1>
          <p class="text-xs text-slate-400">AI-Powered Temporal Analysis</p>
        </div>
      </div>
      <div class="flex items-center gap-2 md:gap-4">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-red-400 animate-pulse-slow"></div>
          <span class="text-xs text-red-300 hidden sm:inline">Detection AI Active</span>
        </div>
        <button id="newAnalysisBtn" class="px-3 py-2 md:px-4 md:py-2 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 rounded-lg text-sm font-medium transition-all duration-200">
          <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
          </svg>
          New Analysis
        </button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-4 md:py-6 max-w-7xl">
    <!-- Analysis Setup -->
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-4 md:gap-6 mb-6">
      <!-- Control Panel -->
      <div class="xl:col-span-1 space-y-4 md:space-y-6 order-2 xl:order-1">
        <!-- Location Selection -->
        <div class="glass-panel rounded-xl p-4 md:p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
            Analysis Area
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-slate-300 mb-2">Location</label>
              <input type="text" id="locationInput" placeholder="Search location..." class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/50 text-sm">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-2">Latitude</label>
                <input type="number" id="latInput" placeholder="37.7749" step="0.0001" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/50 text-sm">
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Longitude</label>
                <input type="number" id="lonInput" placeholder="-122.4194" step="0.0001" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/50 text-sm">
              </div>
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-2">Analysis Radius</label>
              <select id="radiusSelect" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-400/50 text-sm">
                <option value="1">1 km</option>
                <option value="5">5 km</option>
                <option value="10" selected>10 km</option>
                <option value="25">25 km</option>
                <option value="50">50 km</option>
                <option value="100">100 km</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Time Period -->
        <div class="glass-panel rounded-xl p-4 md:p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            Time Period
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-slate-300 mb-2">Analysis Type</label>
              <select id="analysisType" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400/50 text-sm">
                <option value="before-after" selected>Before/After Comparison</option>
                <option value="time-series">Time Series Analysis</option>
                <option value="seasonal">Seasonal Changes</option>
                <option value="anomaly">Anomaly Detection</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-2">Start Date</label>
                <input type="date" id="startDate" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400/50 text-sm">
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">End Date</label>
                <input type="date" id="endDate" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400/50 text-sm">
              </div>
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-2">Temporal Resolution</label>
              <select id="temporalResolution" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400/50 text-sm">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="seasonal">Seasonal</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Data Layers -->
        <div class="glass-panel rounded-xl p-4 md:p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Data Layers
          </h2>
          <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800/50 cursor-pointer transition-all duration-200">
              <input type="checkbox" class="data-layer-checkbox text-emerald-500 focus:ring-emerald-400" value="ndvi" checked>
              <div>
                <div class="text-sm font-medium">NDVI (Vegetation)</div>
                <div class="text-xs text-slate-400">Vegetation health changes</div>
              </div>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800/50 cursor-pointer transition-all duration-200">
              <input type="checkbox" class="data-layer-checkbox text-orange-500 focus:ring-orange-400" value="lst">
              <div>
                <div class="text-sm font-medium">Land Surface Temperature</div>
                <div class="text-xs text-slate-400">Surface temperature changes</div>
              </div>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800/50 cursor-pointer transition-all duration-200">
              <input type="checkbox" class="data-layer-checkbox text-blue-500 focus:ring-blue-400" value="precipitation">
              <div>
                <div class="text-sm font-medium">Precipitation</div>
                <div class="text-xs text-slate-400">Rainfall patterns</div>
              </div>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800/50 cursor-pointer transition-all duration-200">
              <input type="checkbox" class="data-layer-checkbox text-red-500 focus:ring-red-400" value="fire">
              <div>
                <div class="text-sm font-medium">Fire Hotspots</div>
                <div class="text-xs text-slate-400">Wildfire activity</div>
              </div>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800/50 cursor-pointer transition-all duration-200">
              <input type="checkbox" class="data-layer-checkbox text-cyan-500 focus:ring-cyan-400" value="water">
              <div>
                <div class="text-sm font-medium">Water Bodies</div>
                <div class="text-xs text-slate-400">Water extent changes</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Analysis Button -->
        <button id="startAnalysis" class="w-full px-6 py-4 btn-primary rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105 shadow-lg">
          <div class="flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            Start Change Detection
          </div>
        </button>
      </div>

      <!-- Results Area -->
      <div class="xl:col-span-3 space-y-4 md:space-y-6 order-1 xl:order-2">
        <!-- Before/After Comparison -->
        <div class="glass-panel rounded-xl p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 7l9-4 9 4-9 4-9-4zm0 5l9 4 9-4v6l-9 4-9-4v-6z"/>
            </svg>
            Before/After Comparison
          </h3>
          <div class="mb-4 p-3 bg-slate-800/30 rounded-lg border border-slate-600/30">
            <div class="flex items-center gap-2 text-xs text-slate-300 mb-2">
              <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
              <span><strong>Before:</strong> Always shows January 2023 baseline</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-slate-300">
              <div class="w-3 h-3 bg-red-500 rounded-full"></div>
              <span><strong>After:</strong> Shows current timeline position</span>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="comparison-container bg-slate-900/50 rounded-lg border border-slate-600 relative overflow-hidden">
              <div class="absolute top-2 left-2 px-3 py-1 bg-blue-600 rounded-lg text-xs font-medium z-10 shadow-lg" id="beforeLabel">Before: Jan 2023</div>
              <div id="beforeMap" class="w-full h-full relative" style="min-height: 300px;">
                <!-- Before map will be initialized here -->
                <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900">
                  <div class="text-center text-slate-400">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-700 flex items-center justify-center">
                      <svg class="w-8 h-8 text-slate-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                      </svg>
            </div>
                    <p class="text-sm font-medium">Loading Map...</p>
                    <p class="text-xs opacity-75">Blue Marble Satellite View</p>
            </div>
          </div>
              </div>
            </div>
            <div class="comparison-container bg-slate-900/50 rounded-lg border border-slate-600 relative overflow-hidden">
              <div class="absolute top-2 left-2 px-3 py-1 bg-red-600 rounded-lg text-xs font-medium z-10 shadow-lg" id="afterLabel">After: Jan 2024</div>
              <div id="afterMap" class="w-full h-full relative" style="min-height: 300px;">
                <!-- After map will be initialized here -->
                <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900">
                  <div class="text-center text-slate-400">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-700 flex items-center justify-center">
                      <svg class="w-8 h-8 text-slate-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                      </svg>
                    </div>
                    <p class="text-sm font-medium">Loading Map...</p>
                    <p class="text-xs opacity-75">Blue Marble Satellite View</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="glass-panel rounded-lg p-3 md:p-4">
            <h4 class="font-medium mb-3">Change Detection Results</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
              <div class="change-card rounded-lg p-3">
                <div class="text-sm font-medium text-red-300 mb-1">Vegetation Loss</div>
                <div class="text-lg md:text-xl font-bold text-red-400" id="vegLoss">-23.5%</div>
                <div class="text-xs text-slate-400">NDVI decrease</div>
              </div>
              <div class="change-card rounded-lg p-3">
                <div class="text-sm font-medium text-amber-300 mb-1">Temperature Rise</div>
                <div class="text-lg md:text-xl font-bold text-amber-400" id="tempRise">+2.8¬∞C</div>
                <div class="text-xs text-slate-400">Average increase</div>
              </div>
              <div class="change-card rounded-lg p-3">
                <div class="text-sm font-medium text-blue-300 mb-1">Area Affected</div>
                <div class="text-lg md:text-xl font-bold text-blue-400" id="areaAffected">847 km¬≤</div>
                <div class="text-xs text-slate-400">Significant change</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Time Series Analysis -->
        <div class="glass-panel rounded-xl p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L3.5 15.9l.01 2.59z"/>
            </svg>
            Time Series Analysis
          </h3>
          <div class="timeline-card rounded-lg p-3 md:p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-3">
              <span class="text-sm font-medium" id="timelineLabel">Timeline: Jan 2023 - Dec 2024</span>
              <div class="flex items-center gap-2">
                <button id="playBtn" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded text-xs transition-all duration-200 hover:scale-105">‚ñ∂Ô∏è Play</button>
                <button id="resetBtn" class="px-3 py-2 bg-slate-600 hover:bg-slate-500 rounded text-xs transition-all duration-200 hover:scale-105">üîÑ Reset</button>
              </div>
            </div>
            <div class="relative">
              <input type="range" id="timelineSlider" min="0" max="24" value="12" class="w-full h-3 timeline-slider rounded-lg appearance-none cursor-pointer">
              <div class="flex justify-between text-xs text-slate-400 mt-2">
                <span id="timelineStart">Jan 2023</span>
                <span>Jun 2023</span>
                <span>Dec 2023</span>
                <span>Jun 2024</span>
                <span id="timelineEnd">Dec 2024</span>
              </div>
            </div>
          </div>
          <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 h-48 md:h-64 flex items-center justify-center">
            <div class="text-center text-slate-400">
              <div class="relative w-full h-full">
                <!-- Simple SVG Chart Visualization -->
                <svg class="w-full h-full" viewBox="0 0 400 200">
                  <!-- Grid lines -->
                  <defs>
                    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#374151" stroke-width="0.5" opacity="0.3"/>
                    </pattern>
                  </defs>
                  <rect width="100%" height="100%" fill="url(#grid)" />

                  <!-- Chart area -->
                  <rect x="40" y="20" width="340" height="160" fill="rgba(30, 41, 59, 0.8)" rx="8"/>

                  <!-- Sample data line -->
                  <polyline points="50,150 80,140 110,120 140,100 170,90 200,95 230,110 260,130 290,140 320,135 350,145"
                           fill="none" stroke="#10b981" stroke-width="3" opacity="0.8"/>

                  <!-- Data points -->
                  <circle cx="50" cy="150" r="3" fill="#10b981"/>
                  <circle cx="110" cy="120" r="3" fill="#10b981"/>
                  <circle cx="170" cy="90" r="3" fill="#10b981"/>
                  <circle cx="230" cy="110" r="3" fill="#10b981"/>
                  <circle cx="290" cy="140" r="3" fill="#10b981"/>
                  <circle cx="350" cy="145" r="3" fill="#10b981"/>

                  <!-- Y-axis labels -->
                  <text x="15" y="30" class="text-xs fill-slate-400">100</text>
                  <text x="15" y="70" class="text-xs fill-slate-400">75</text>
                  <text x="15" y="110" class="text-xs fill-slate-400">50</text>
                  <text x="15" y="150" class="text-xs fill-slate-400">25</text>

                  <!-- X-axis labels -->
                  <text x="50" y="185" class="text-xs fill-slate-400">Jan</text>
                  <text x="110" y="185" class="text-xs fill-slate-400">Mar</text>
                  <text x="170" y="185" class="text-xs fill-slate-400">Jun</text>
                  <text x="230" y="185" class="text-xs fill-slate-400">Sep</text>
                  <text x="290" y="185" class="text-xs fill-slate-400">Nov</text>
                  <text x="350" y="185" class="text-xs fill-slate-400">Jan</text>

                  <!-- Title -->
                  <text x="200" y="15" class="text-sm fill-slate-300 font-medium text-center">Vegetation Health Trend</text>
              </svg>
              </div>
              <p class="text-sm font-medium mt-2">Interactive Time Series Chart</p>
              <p class="text-xs opacity-75">Shows temporal changes in selected parameters</p>
            </div>
          </div>
        </div>

        <!-- Anomaly Detection -->
        <div class="glass-panel rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Detected Anomalies
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="analysis-card rounded-lg p-4">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-3 h-3 rounded-full bg-red-400 mt-1"></div>
                <div>
                  <h4 class="font-semibold text-red-300 mb-1">Rapid Vegetation Loss</h4>
                  <p class="text-sm text-zinc-300 mb-2">Detected significant NDVI decrease in northern sector between March-May 2024.</p>
                  <div class="flex items-center gap-2 text-xs text-zinc-400">
                    <span>Confidence: 94%</span>
                    <span>‚Ä¢</span>
                    <span>Area: 234 km¬≤</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="analysis-card rounded-lg p-4">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-3 h-3 rounded-full bg-orange-400 mt-1"></div>
                <div>
                  <h4 class="font-semibold text-orange-300 mb-1">Temperature Spike</h4>
                  <p class="text-sm text-zinc-300 mb-2">Unusual temperature increase of 5.2¬∞C above normal detected in July 2024.</p>
                  <div class="flex items-center gap-2 text-xs text-zinc-400">
                    <span>Confidence: 87%</span>
                    <span>‚Ä¢</span>
                    <span>Duration: 12 days</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="analysis-card rounded-lg p-4">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-3 h-3 rounded-full bg-blue-400 mt-1"></div>
                <div>
                  <h4 class="font-semibold text-blue-300 mb-1">Water Body Changes</h4>
                  <p class="text-sm text-zinc-300 mb-2">Significant reduction in water extent detected, possibly due to drought conditions.</p>
                  <div class="flex items-center gap-2 text-xs text-zinc-400">
                    <span>Confidence: 91%</span>
                    <span>‚Ä¢</span>
                    <span>Reduction: 45%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="analysis-card rounded-lg p-4">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-3 h-3 rounded-full bg-purple-400 mt-1"></div>
                <div>
                  <h4 class="font-semibold text-purple-300 mb-1">Seasonal Anomaly</h4>
                  <p class="text-sm text-zinc-300 mb-2">Vegetation green-up occurred 3 weeks earlier than historical average in spring 2024.</p>
                  <div class="flex items-center gap-2 text-xs text-zinc-400">
                    <span>Confidence: 78%</span>
                    <span>‚Ä¢</span>
                    <span>Shift: -21 days</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistical Analysis -->
        <div class="glass-panel rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Statistical Analysis</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-zinc-800/50 rounded-lg p-4">
              <div class="text-sm text-zinc-300 mb-1">Change Magnitude</div>
              <div class="text-2xl font-bold text-red-400">High</div>
              <div class="text-xs text-zinc-500">Above 75th percentile</div>
            </div>
            <div class="bg-zinc-800/50 rounded-lg p-4">
              <div class="text-sm text-zinc-300 mb-1">Trend Direction</div>
              <div class="text-2xl font-bold text-orange-400">Declining</div>
              <div class="text-xs text-zinc-500">Negative slope: -0.23</div>
            </div>
            <div class="bg-zinc-800/50 rounded-lg p-4">
              <div class="text-sm text-zinc-300 mb-1">Seasonality</div>
              <div class="text-2xl font-bold text-blue-400">Strong</div>
              <div class="text-xs text-zinc-500">R¬≤ = 0.84</div>
            </div>
            <div class="bg-zinc-800/50 rounded-lg p-4">
              <div class="text-sm text-zinc-300 mb-1">Variability</div>
              <div class="text-2xl font-bold text-green-400">Moderate</div>
              <div class="text-xs text-zinc-500">CV = 0.32</div>
            </div>
          </div>
        </div>

        <!-- AI Insights -->
        <div class="glass-panel rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            AI-Generated Insights
          </h3>
          <div class="space-y-4">
            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
              <h4 class="font-semibold text-red-300 mb-2">Critical Change Detected</h4>
              <p class="text-sm text-zinc-300">The analysis reveals a concerning pattern of rapid vegetation decline coinciding with temperature increases. This suggests potential ecosystem stress that may lead to increased wildfire risk and reduced carbon sequestration capacity.</p>
            </div>
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
              <h4 class="font-semibold text-blue-300 mb-2">Temporal Correlation</h4>
              <p class="text-sm text-zinc-300">Strong correlation (r=0.78) between temperature anomalies and vegetation health decline suggests climate-driven ecosystem changes. The timing aligns with regional drought conditions reported in meteorological data.</p>
            </div>
            <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
              <h4 class="font-semibold text-yellow-300 mb-2">Predictive Indicators</h4>
              <p class="text-sm text-zinc-300">Current trends indicate continued degradation if conditions persist. Recommend monitoring soil moisture levels and implementing conservation measures in the most affected areas identified in the northern sector.</p>
            </div>
          </div>
        </div>

        <!-- Export Options -->
        <div class="glass-panel rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Export & Share</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <button class="px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                </svg>
                Analysis Report
              </div>
            </button>
            <button class="px-4 py-3 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Export Data
              </div>
            </button>
            <button class="px-4 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M3 7l9-4 9 4-9 4-9-4zm0 5l9 4 9-4v6l-9 4-9-4v-6z"/>
                </svg>
                Save Project
              </div>
            </button>
            <button class="px-4 py-3 bg-orange-600 hover:bg-orange-500 rounded-lg text-sm font-medium transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.50-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                </svg>
                Share Analysis
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Modal -->
  <div id="processingModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="glass-panel rounded-xl p-8 max-w-md w-full mx-4">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-red-500/20 border-t-red-500 rounded-full animate-spin mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold mb-2">Processing Change Detection</h3>
        <p class="text-sm text-zinc-400 mb-4">AI is analyzing temporal patterns and detecting changes...</p>
        <div class="text-xs text-zinc-500 space-y-1">
          <div>‚Ä¢ Loading satellite imagery</div>
          <div>‚Ä¢ Performing temporal analysis</div>
          <div>‚Ä¢ Detecting anomalies</div>
          <div>‚Ä¢ Generating insights</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <script>
    // API Configuration
    const GEMINI_API_KEY = 'AIzaSyCGYNwiZz-LZSURDdQZhmLVFTRI6cjtqm8';
    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
    
    // Set Mapbox access token
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // Real data APIs
    const NASA_API_KEY = 'DEMO_KEY';

    // Gemini API call function with retry logic
    async function callGeminiAPI(prompt, maxRetries = 2) {
      let retries = 0;

      while (retries <= maxRetries) {
      try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }],
            generationConfig: {
              temperature: 0.7,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 1024,
            }
          })
        });

        if (!response.ok) {
            if (response.status === 429 && retries < maxRetries) {
              // Rate limited, wait and retry
              const waitTime = Math.pow(2, retries) * 1000; // Exponential backoff
              console.log(`Rate limited, retrying in ${waitTime}ms...`);
              await new Promise(resolve => setTimeout(resolve, waitTime));
              retries++;
              continue;
            }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
        return data.candidates[0].content.parts[0].text;
          } else {
            throw new Error('Invalid API response format');
          }

      } catch (error) {
          console.error(`Gemini API Error (attempt ${retries + 1}):`, error);

          if (retries >= maxRetries) {
            // Return fallback analysis based on the prompt type
            return getFallbackAnalysis(prompt);
          }

          retries++;
          if (retries <= maxRetries) {
            const waitTime = Math.pow(2, retries) * 1000;
            console.log(`Retrying in ${waitTime}ms...`);
            await new Promise(resolve => setTimeout(resolve, waitTime));
          }
        }
      }
    }

    // Provide fallback analysis when API fails
    function getFallbackAnalysis(prompt) {
      if (prompt.includes('temporal changes')) {
        return `Based on the analysis parameters, this location shows typical seasonal variations with potential long-term trends. The temporal analysis reveals:

‚Ä¢ **Vegetation Patterns**: Expected seasonal cycles with possible shifts due to climate factors
‚Ä¢ **Temperature Trends**: Normal variations within historical ranges
‚Ä¢ **Environmental Drivers**: Standard meteorological and anthropogenic influences
‚Ä¢ **Monitoring Recommendations**: Continue regular observations to track any deviations from baseline patterns

Statistical analysis indicates moderate correlation between environmental variables with confidence levels above 80%. Further ground-based verification would strengthen these findings.`;
      } else if (prompt.includes('anomalies')) {
        return `The change detection analysis identified several areas requiring attention:

‚Ä¢ **Statistical Anomalies**: Values within normal ranges but showing unusual temporal patterns
‚Ä¢ **Confidence Assessment**: 85-92% confidence in detected changes
‚Ä¢ **Environmental Impact**: Moderate ecosystem stress indicators present
‚Ä¢ **Follow-up Actions**: Recommend field verification and extended monitoring period

These findings suggest environmental changes that warrant continued observation and potential intervention planning.`;
      }

      return 'Analysis completed with standard environmental monitoring protocols. Changes detected fall within expected parameters for the specified time period and location. Further investigation may be warranted for anomalies exceeding 2 standard deviations from baseline measurements.';
    }

    // Toggle SST layer for both maps
    function toggleSSTLayer(enabled) {
      if (enabled) {
        // Add SST layer to both maps
        if (beforeSSTLayer && beforeMap && !beforeMap.hasLayer(beforeSSTLayer)) {
          beforeSSTLayer.addTo(beforeMap);
        }
        if (afterSSTLayer && afterMap && !afterMap.hasLayer(afterSSTLayer)) {
          afterSSTLayer.addTo(afterMap);
        }
        updateStatus('SST Layer Enabled');
      } else {
        // Remove SST layer from both maps
        if (beforeSSTLayer && beforeMap && beforeMap.hasLayer(beforeSSTLayer)) {
          beforeMap.removeLayer(beforeSSTLayer);
        }
        if (afterSSTLayer && afterMap && afterMap.hasLayer(afterSSTLayer)) {
          afterMap.removeLayer(afterSSTLayer);
        }
        updateStatus('SST Layer Disabled');
      }
    }

    // Toggle data layers
    function toggleDataLayer(layerName, enabled) {
      if (layerName === 'lst') {
        // Toggle LST (Land Surface Temperature) layer
        toggleLSTLayer(enabled);
      } else if (layerName === 'precipitation') {
        // LST is the SST layer in this context - this is handled by the checkbox
        toggleSSTLayer(enabled);
      } else {
        // Placeholder for other data layers like NDVI, fire, water, etc.
        console.log(`Toggling ${layerName} layer: ${enabled}`);
        updateStatus(`${layerName.toUpperCase()} Layer ${enabled ? 'Enabled' : 'Disabled'}`);
      }
    }

    // Toggle LST layer for both maps
    function toggleLSTLayer(enabled) {
      if (enabled) {
        // Add LST layer to both maps
        if (beforeLSTLayer && beforeMap && !beforeMap.hasLayer(beforeLSTLayer)) {
          beforeLSTLayer.addTo(beforeMap);
        }
        if (afterLSTLayer && afterMap && !afterMap.hasLayer(afterLSTLayer)) {
          afterLSTLayer.addTo(afterMap);
        }
        updateStatus('LST Layer Enabled');
      } else {
        // Remove LST layer from both maps
        if (beforeLSTLayer && beforeMap && beforeMap.hasLayer(beforeLSTLayer)) {
          beforeMap.removeLayer(beforeLSTLayer);
        }
        if (afterLSTLayer && afterMap && afterMap.hasLayer(afterLSTLayer)) {
          afterMap.removeLayer(afterLSTLayer);
        }
        updateStatus('LST Layer Disabled');
      }
    }

    // Analyze temporal changes using Gemini
    async function analyzeTemporalChanges(location, startDate, endDate, dataLayers) {
      const prompt = `
        As an expert in remote sensing and environmental change detection, analyze temporal changes for the following scenario:

        Location: ${location}
        Time Period: ${startDate} to ${endDate}
        Data Layers: ${dataLayers.join(', ')}

        Provide a comprehensive analysis including:
        1. Expected types of changes for this location and time period
        2. Potential environmental drivers of change
        3. Seasonal vs. long-term trend considerations
        4. Key indicators to monitor
        5. Statistical significance of detected changes
        6. Confidence levels and uncertainty factors
        7. Recommendations for further monitoring

        Focus on quantitative analysis where possible and explain the scientific methodology.
        Format your response with clear sections and specific insights.
      `;

      try {
        return await callGeminiAPI(prompt);
      } catch (error) {
        console.error('Temporal analysis error:', error);
        return 'Unable to generate temporal analysis at this time.';
      }
    }

    // Detect anomalies using AI
    async function detectAnomalies(changeData) {
      const prompt = `
        Analyze the following change detection data and identify anomalies:

        Change Data: ${JSON.stringify(changeData, null, 2)}

        Identify:
        1. Statistical anomalies (values beyond normal ranges)
        2. Temporal anomalies (unusual timing of changes)
        3. Spatial anomalies (localized unusual patterns)
        4. Trend anomalies (unexpected directional changes)

        For each anomaly, provide:
        - Type and severity (low/medium/high)
        - Confidence level (0-100%)
        - Potential causes
        - Recommended follow-up actions

        Format as structured analysis with clear anomaly classifications.
      `;

      try {
        return await callGeminiAPI(prompt);
      } catch (error) {
        console.error('Anomaly detection error:', error);
        return 'Unable to detect anomalies at this time.';
      }
    }

    // Initialize maps with Blue Marble base layer
    let beforeMap, afterMap;
    let beforeBaseLayer, afterBaseLayer;
    let beforeSSTLayer, afterSSTLayer;
    let beforeLSTLayer, afterLSTLayer;
    let mapsInitialized = false;

    function destroyMaps() {
      if (beforeMap) {
        beforeMap.remove();
        beforeMap = null;
      }
      if (afterMap) {
        afterMap.remove();
        afterMap = null;
      }
      beforeBaseLayer = null;
      afterBaseLayer = null;
      beforeSSTLayer = null;
      afterSSTLayer = null;
      beforeLSTLayer = null;
      afterLSTLayer = null;
      mapsInitialized = false;
    }
    
    function initMaps(coordinates) {
      // Prevent double initialization
      if (mapsInitialized) {
        console.log('Maps already initialized, skipping...');
        return { beforeMap, afterMap };
      }

      const center = coordinates ? [coordinates.lat, coordinates.lon] : [37.7749, -122.4194];
      const zoom = coordinates ? 6 : 3;

      console.log('Initializing maps with center:', center, 'zoom:', zoom);

      // Initialize before map
      try {
        const beforeContainer = document.getElementById('beforeMap');
        if (!beforeContainer) {
          console.error('Before map container not found');
          return;
        }

        // Clear any existing content and ensure clean slate
        beforeContainer.innerHTML = '';
        beforeContainer.style.width = '100%';
        beforeContainer.style.height = '100%';

        beforeMap = L.map('beforeMap', {
        center: center,
          zoom: zoom,
          minZoom: 1,
          maxZoom: 8,
          zoomControl: true,
          attributionControl: false,
          fadeAnimation: true,
          zoomAnimation: true,
          preferCanvas: false
        });

        console.log('Before map object created');

        // Add Blue Marble base layer
        beforeBaseLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/BlueMarble_ShadedRelief_Bathymetry/default/2025-10-02/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg', {
          maxZoom: 8,
          tileSize: 256,
          attribution: 'NASA GIBS',
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
        }).addTo(beforeMap);

        // Add SST layer (initially hidden)
        beforeSSTLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/GHRSST_L4_MUR_Sea_Surface_Temperature/default/2024-09-15/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', {
          maxZoom: 7,
          opacity: 0.8,
          tileSize: 256,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
        });

        // Add LST layer (initially hidden) - Land Surface Temperature
        beforeLSTLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/2025-09-29/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', {
          maxZoom: 7,
          opacity: 0.8,
          tileSize: 256,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
          crossOrigin: 'anonymous'
        });

        console.log('Before map initialized successfully');

      } catch (error) {
        console.error('Failed to initialize before map:', error);
        showMapError('beforeMap', 'Before');
        return;
      }

      // Initialize after map
      try {
        const afterContainer = document.getElementById('afterMap');
        if (!afterContainer) {
          console.error('After map container not found');
          return;
        }

        // Clear any existing content and ensure clean slate
        afterContainer.innerHTML = '';
        afterContainer.style.width = '100%';
        afterContainer.style.height = '100%';

        afterMap = L.map('afterMap', {
        center: center,
          zoom: zoom,
          minZoom: 1,
          maxZoom: 8,
          zoomControl: true,
          attributionControl: false,
          fadeAnimation: true,
          zoomAnimation: true,
          preferCanvas: false
        });

        console.log('After map object created');

        // Add Blue Marble base layer
        afterBaseLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/BlueMarble_ShadedRelief_Bathymetry/default/2025-10-02/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg', {
          maxZoom: 8,
          tileSize: 256,
          attribution: 'NASA GIBS',
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
        }).addTo(afterMap);

        // Add SST layer (initially hidden)
        afterSSTLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/GHRSST_L4_MUR_Sea_Surface_Temperature/default/2024-09-15/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', {
          maxZoom: 7,
          opacity: 0.8,
          tileSize: 256,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
        });

        // Add LST layer (initially hidden) - Land Surface Temperature
        afterLSTLayer = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/2025-09-29/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', {
          maxZoom: 7,
          opacity: 0.8,
          tileSize: 256,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
          crossOrigin: 'anonymous'
        });

        console.log('After map initialized successfully');

      } catch (error) {
        console.error('Failed to initialize after map:', error);
        showMapError('afterMap', 'After');
        return;
      }

      // Synchronize map movements if both maps exist
      if (beforeMap && afterMap) {
      beforeMap.on('move', () => {
          if (afterMap && !afterMap._moving) {
            afterMap.setView(beforeMap.getCenter(), beforeMap.getZoom(), { animate: false });
          }
      });

      afterMap.on('move', () => {
          if (beforeMap && !beforeMap._moving) {
            beforeMap.setView(afterMap.getCenter(), afterMap.getZoom(), { animate: false });
          }
        });

        console.log('Map synchronization enabled');
        mapsInitialized = true;
      }

      if (coordinates && beforeMap) {
        // Add markers if coordinates provided and map initialized
        try {
          const beforeMarker = L.marker([coordinates.lat, coordinates.lon], {
            icon: L.divIcon({
              className: 'custom-marker',
              html: '<div style="background-color: #3b82f6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);"></div>',
              iconSize: [16, 16],
              iconAnchor: [8, 8]
            })
          }).addTo(beforeMap);

          if (afterMap) {
            const afterMarker = L.marker([coordinates.lat, coordinates.lon], {
              icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background-color: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
              })
            }).addTo(afterMap);

            console.log('Markers added successfully');
          }
        } catch (error) {
          console.error('Failed to add markers:', error);
        }
      }

      return { beforeMap, afterMap };
    }

    // Show map error placeholder
    function showMapError(containerId, mapType) {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = `
          <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-red-900/20 to-red-800/20 border-2 border-red-500/30">
            <div class="text-center text-red-400">
              <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <p class="text-sm font-medium">Map Error</p>
              <p class="text-xs opacity-75">${mapType} map failed to load</p>
            </div>
          </div>
        `;
      }
    }

    // Geocoding function
    async function geocodeLocation(location) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          return {
            lat: parseFloat(data[0].lat),
            lon: parseFloat(data[0].lon),
            display_name: data[0].display_name
          };
        }
      } catch (error) {
        console.error('Geocoding error:', error);
      }
      return null;
    }

    // Generate mock change data for demonstration
    function generateChangeData(location, startDate, endDate) {
      return {
        location: location,
        timeframe: `${startDate} to ${endDate}`,
        vegetationChange: -23.5,
        temperatureChange: 2.8,
        areaAffected: 847,
        confidence: 94,
        changeType: 'vegetation_loss',
        severity: 'high'
      };
    }

    // Update UI with analysis results
    function updateAnalysisResults(location, changeData, temporalAnalysis, anomalies) {
      // Update change detection results
      const changeCards = document.querySelectorAll('.change-card');
      if (changeCards.length >= 3) {
        // Vegetation loss
        const vegCard = changeCards[0];
        const vegValue = vegCard.querySelector('.text-xl');
        if (vegValue) vegValue.textContent = `${changeData.vegetationChange}%`;

        // Temperature rise
        const tempCard = changeCards[1];
        const tempValue = tempCard.querySelector('.text-xl');
        if (tempValue) tempValue.textContent = `+${changeData.temperatureChange}¬∞C`;

        // Area affected
        const areaCard = changeCards[2];
        const areaValue = areaCard.querySelector('.text-xl');
        if (areaValue) areaValue.textContent = `${changeData.areaAffected} km¬≤`;
      }

      // Update AI insights
      const insightsSection = document.querySelector('.glass-panel:last-child .space-y-4');
      if (insightsSection) {
        insightsSection.innerHTML = `
          <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
            <h4 class="font-semibold text-red-300 mb-2">Temporal Analysis Results</h4>
            <div class="text-sm text-zinc-300 whitespace-pre-line">${temporalAnalysis}</div>
          </div>
          <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-300 mb-2">Anomaly Detection</h4>
            <div class="text-sm text-zinc-300 whitespace-pre-line">${anomalies}</div>
          </div>
        `;
      }

      // Update statistical analysis
      const statsCards = document.querySelectorAll('.bg-zinc-800\\/50');
      if (statsCards.length >= 4) {
        // Change magnitude
        const magnitudeValue = statsCards[0].querySelector('.text-2xl');
        if (magnitudeValue) magnitudeValue.textContent = changeData.severity === 'high' ? 'High' : 'Medium';

        // Confidence
        const confidenceCard = statsCards[3];
        const confidenceValue = confidenceCard.querySelector('.text-2xl');
        if (confidenceValue) confidenceValue.textContent = `${changeData.confidence}%`;
      }
    }

    // Main functionality
    document.addEventListener('DOMContentLoaded', function() {
      const startBtn = document.getElementById('startAnalysis');
      const newAnalysisBtn = document.getElementById('newAnalysisBtn');
      const processingModal = document.getElementById('processingModal');
      const locationInput = document.getElementById('locationInput');
      const latInput = document.getElementById('latInput');
      const lonInput = document.getElementById('lonInput');
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const timelineSlider = document.getElementById('timelineSlider');
      const timelineLabel = document.getElementById('timelineLabel');
      const timelineStart = document.getElementById('timelineStart');
      const timelineEnd = document.getElementById('timelineEnd');
      const playBtn = document.getElementById('playBtn');
      const resetBtn = document.getElementById('resetBtn');
      
      // Set default dates
      const today = new Date();
      const lastYear = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
      
      if (startDateInput) startDateInput.value = lastYear.toISOString().split('T')[0];
      if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];

      // Initialize timeline display
      if (timelineSlider) {
        updateTimelineDisplay(parseInt(timelineSlider.value));
        updateMapLabels(); // Ensure labels are correct on page load
      }

      // Timeline animation variables
      let timelineAnimation = null;
      let isPlaying = false;
      
      // Handle analysis start
      async function startAnalysis() {
        const location = locationInput.value.trim() || 'San Francisco, CA';
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (!startDate || !endDate) {
          alert('Please select both start and end dates.');
          return;
        }

        processingModal.classList.remove('hidden');
        
        try {
          // Get coordinates for location
          const coordinates = await geocodeLocation(location);
          
          // Get selected data layers
          const selectedLayers = [];
          document.querySelectorAll('.data-layer-checkbox:checked').forEach(checkbox => {
            selectedLayers.push(checkbox.value);
          });

          // Generate change data
          const changeData = generateChangeData(location, startDate, endDate);

          // Perform temporal analysis
          const temporalAnalysis = await analyzeTemporalChanges(location, startDate, endDate, selectedLayers);

          // Detect anomalies
          const anomalies = await detectAnomalies(changeData);

          // Update UI
          updateAnalysisResults(location, changeData, temporalAnalysis, anomalies);

          // Destroy existing maps and reinitialize with new coordinates
          destroyMaps();
          setTimeout(() => {
            const maps = initMaps(coordinates);
            console.log('Maps initialized:', maps);
          }, 200);
          
          // Update coordinate inputs
          if (coordinates) {
            latInput.value = coordinates.lat.toFixed(4);
            lonInput.value = coordinates.lon.toFixed(4);
          }

          // Initialize timeline display and layers with proper before/after dates
          if (timelineSlider) {
            const initialValue = parseInt(timelineSlider.value);
            updateTimelineDisplay(initialValue);
            updateMapLabels(); // Update labels immediately

            // Set initial layer dates - Before uses Jan 2023, After uses current timeline position
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            const startYear = 2023;
            const endYear = initialValue < 12 ? 2023 : 2024;
            const startMonth = months[0]; // Always January for "before"
            const endMonth = months[initialValue % 12];

            // Initialize before layer with January 2023 data
            if (beforeLSTLayer && beforeMap) {
              const beforeUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/${startYear}-${startMonth}-15/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`;
              beforeLSTLayer.setUrl(beforeUrl);
            }

            // Initialize after layer with current timeline data
            if (afterLSTLayer && afterMap) {
              const afterUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/${endYear}-${endMonth}-15/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`;
              afterLSTLayer.setUrl(afterUrl);
            }
          }
          
          // Scroll to results
          document.querySelector('.xl\\:col-span-3').scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          console.error('Analysis error:', error);
          alert('Unable to complete change detection analysis. Please check your internet connection and try again.');
        } finally {
          processingModal.classList.add('hidden');
        }
      }

      if (startBtn) {
        startBtn.addEventListener('click', startAnalysis);
      }

      if (newAnalysisBtn) {
        newAnalysisBtn.addEventListener('click', function() {
          // Reset form and start new analysis
          if (locationInput) locationInput.value = 'California, USA';
          if (latInput) latInput.value = '';
          if (lonInput) lonInput.value = '';

          // Destroy existing maps before starting new analysis
          destroyMaps();
          setTimeout(() => {
            startAnalysis();
          }, 100);
        });
      }
      
      // Timeline slider interaction
      if (timelineSlider) {
        timelineSlider.addEventListener('input', function() {
          const value = parseInt(this.value);
          updateTimelineDisplay(value);
          updateLayersWithTimeline(value);
        });
      }

      // Function to update timeline display and labels
      function updateTimelineDisplay(value) {
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const year = value < 12 ? 2023 : 2024;
          const month = months[value % 12];
          
        if (timelineLabel) timelineLabel.textContent = `Timeline: ${month} ${year}`;

        // Update map labels
        updateMapLabels();
      }

      // Function to update before/after map labels
      function updateMapLabels() {
        const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];

        // Before label always shows January 2023
        const beforeLabel = document.getElementById('beforeLabel');
        if (beforeLabel) {
          beforeLabel.textContent = 'Before: Jan 2023';
        }

        // After label shows current timeline position
        const currentValue = parseInt(document.getElementById('timelineSlider')?.value || 12);
        const endYear = currentValue < 12 ? 2023 : 2024;
        const endMonth = months[currentValue % 12];
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthName = monthNames[currentValue % 12];

        const afterLabel = document.getElementById('afterLabel');
        if (afterLabel) {
          afterLabel.textContent = `After: ${monthName} ${endYear}`;
        }
      }

      // Function to update layers with timeline value
      function updateLayersWithTimeline(value) {
        const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];

        // Calculate dates for before/after comparison
        const startYear = 2023; // Fixed start year
        const endYear = value < 12 ? 2023 : 2024;
        const startMonth = months[0]; // Always January for "before"
        const endMonth = months[value % 12];
        const day = '15';

        const beforeDateStr = `${startYear}-${startMonth}-${day}`;
        const afterDateStr = `${endYear}-${endMonth}-${day}`;

        // Update LST layers - Before map uses fixed early date, After map uses timeline date
        if (beforeLSTLayer && beforeMap && beforeMap.hasLayer(beforeLSTLayer)) {
          const beforeUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/${beforeDateStr}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`;
          beforeLSTLayer.setUrl(beforeUrl);
        }

        if (afterLSTLayer && afterMap && afterMap.hasLayer(afterLSTLayer)) {
          const afterUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/${afterDateStr}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`;
          afterLSTLayer.setUrl(afterUrl);
        }

        console.log(`Updated layers - Before: ${beforeDateStr}, After: ${afterDateStr}`);
      }

      // Play/Reset timeline animation
      if (playBtn) {
        playBtn.addEventListener('click', function() {
          if (isPlaying) {
            // Stop animation
            if (timelineAnimation) {
              clearInterval(timelineAnimation);
            }
            isPlaying = false;
            playBtn.textContent = '‚ñ∂Ô∏è Play';
          } else {
            // Start animation
            isPlaying = true;
            playBtn.textContent = '‚è∏Ô∏è Pause';

            timelineAnimation = setInterval(() => {
              const currentValue = parseInt(timelineSlider.value);
              if (currentValue >= 24) {
                // Reset to beginning
                timelineSlider.value = 0;
                updateTimelineDisplay(0);
                updateLayersWithTimeline(0);
              } else {
                timelineSlider.value = currentValue + 1;
                updateTimelineDisplay(currentValue + 1);
                updateLayersWithTimeline(currentValue + 1);
              }
            }, 500);
          }
        });
      }

      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          if (timelineAnimation) {
            clearInterval(timelineAnimation);
          }
          isPlaying = false;
          if (playBtn) playBtn.textContent = '‚ñ∂Ô∏è Play';
          if (timelineSlider) timelineSlider.value = 12;
          updateTimelineDisplay(12);
          updateLayersWithTimeline(12);
        });
      }

      // Data layer checkbox event listeners
      document.querySelectorAll('.data-layer-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const layerName = this.value;
          const enabled = this.checked;
          toggleDataLayer(layerName, enabled);
        });
      });

      // Auto-start analysis with default location
      setTimeout(() => {
        if (locationInput) locationInput.value = 'California, USA';
        startAnalysis();
      }, 1000);
    });

    // Ensure Leaflet is loaded before initializing maps
    function initializeMapsWhenReady() {
      if (typeof L !== 'undefined' && !mapsInitialized) {
        // Initialize maps after a short delay to ensure DOM is ready
        setTimeout(() => {
          const coordinates = { lat: 37.7749, lon: -122.4194 }; // Default coordinates
          initMaps(coordinates);
        }, 500);
      } else if (!mapsInitialized) {
        // Retry after a delay if Leaflet isn't loaded yet
        setTimeout(initializeMapsWhenReady, 100);
      }
    }

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeMapsWhenReady);
    } else {
      initializeMapsWhenReady();
    }
  </script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>